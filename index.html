<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>CRM Agente Lenti – PWA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <style>
    :root{ --safe-b: env(safe-area-inset-bottom); --safe-t: env(safe-area-inset-top) }
    @media print { .no-print { display:none!important } body{ background:white!important } }
    body { background:#f8fafc; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .btn { padding:8px 12px; border-radius:12px; font-size:14px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
    .btn:hover { background:#f1f5f9; }
    .btn-primary { padding:8px 12px; border-radius:12px; font-size:14px; background:#2563eb; color:#fff; border:1px solid #1d4ed8; cursor:pointer; }
    .btn-primary:hover { background:#1d4ed8; }
    .card { background:#fff; border-radius:16px; border:1px solid #e2e8f0; box-shadow:0 1px 1px rgba(0,0,0,.02); }
    .card-h { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #f1f5f9; }
    .card-b { padding:16px; }
    .pill { border-radius:9999px; padding:2px 8px; border:1px solid #e2e8f0; font-size:12px; }
    #drawer{ position:fixed; top:0; bottom:0; left:0; width:280px; background:#fff; border-right:1px solid #e2e8f0; transform:translateX(-100%); transition:transform .2s ease; z-index:50; padding:12px; }
    #drawer.open{ transform:translateX(0) }
    #scrim{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; z-index:40 }
    #scrim.show{ display:block }
  </style>
</head>
<body>
  <div id="scrim" class="no-print"></div>
  <div id="drawer" class="no-print">
    <div class="text-lg font-bold mb-3">☰ Navigazione</div>
    <nav id="nav"></nav>
    <div class="mt-6 text-xs text-slate-500">Scorciatoie</div>
    <div class="mt-2 flex flex-wrap gap-2">
      <button class="btn" data-route="visite" data-s="quick">+ Visita</button>
      <button class="btn" data-route="fatturati" data-s="quick">+ Fatturato</button>
      <button class="btn" data-route="promo" data-s="quick">+ Promo</button>
    </div>
  </div>
  <div id="app"></div>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.warn);
      });
    }
    const lsGet=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
    const lsSet=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const fmtEuro=n=>(Number(n)||0).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
    const fmtDate=s=>s?new Date(s).toLocaleDateString('it-IT'):'';
    const today=()=>new Date().toISOString().slice(0,10);
    const yyyymm=()=>new Date().toISOString().slice(0,7);
    const addDays=(iso,days)=>{const d=new Date(iso||today());d.setDate(d.getDate()+Number(days||0));return d.toISOString().slice(0,10)};
    const daysBetween=(a,b)=>{const A=new Date(a),B=new Date(b);return Math.round((B-A)/(1000*60*60*24))};
    const monthEnd=(ym)=> new Date(new Date(ym+'-01').getFullYear(), new Date(ym+'-01').getMonth()+1, 0);
    function isoWeekStart(year, week){
      const simple = new Date(year,0,1+ (week-1)*7);
      const dow = simple.getDay(); const ISOweekStart = simple;
      const diff = (dow<=4 ? 1-dow : 8-dow);
      ISOweekStart.setDate(simple.getDate()+diff);
      return ISOweekStart;
    }
    const DEFAULT_SETTINGS={agencyName:'Marinelli Optodinamica – Agente',agentName:'Agente Demo',baseCity:'Padova',freqStandard:90,freqImportant:30,freqNew:21, annualGoal:130000};
    const TRIVENETO={ 'Veneto':['PD','VE','TV','VI','VR','RO','BL'], 'Trentino-Alto Adige/Südtirol':['TN','BZ'], 'Friuli Venezia Giulia':['TS','GO','PN','UD'] };
    function ensureSeeds(){
      if(!lsGet('settings')) lsSet('settings',DEFAULT_SETTINGS);
      if(!lsGet('clients')?.length) lsSet('clients',[
        {id:'C-001',code:'OTT-PD',name:'Ottica Prato della Valle',contact:'Giulia',phone:'049...',email:'pd@ottica.it',address:'Prato della Valle 1, Padova',city:'Padova',prov:'PD',region:'Veneto',status:'attivo',tier:'importante',goalMonthly:3000,prepagatoRenewal:'',lastVisitDate:'',nextVisitDate:'',notes:''},
        {id:'C-002',code:'OTT-VE',name:'Ottica Rialto',contact:'Luca',phone:'041...',email:'ve@ottica.it',address:'San Polo 100, Venezia',city:'Venezia',prov:'VE',region:'Veneto',status:'lead',tier:'nuovo',goalMonthly:1500,prepagatoRenewal:'',lastVisitDate:'',nextVisitDate:'',notes:'Interessati a progressive'}
      ]);
      if(!lsGet('visits')) lsSet('visits',[]);
      if(!lsGet('promos')) lsSet('promos',[]);
      if(!lsGet('sales')) lsSet('sales',[]);
      if(!lsGet('salesW')) lsSet('salesW',[]);
      if(!lsGet('tours')) lsSet('tours',[]);
      if(!lsGet('firebase')) lsSet('firebase',{enabled:false, config:null, agentId:''});
    }
    ensureSeeds();
    const getSettings=()=>lsGet('settings',DEFAULT_SETTINGS);
    const setSettings=v=>lsSet('settings',v);
    const getClients=()=>lsGet('clients',[]), setClients=v=>lsSet('clients',v);
    const getVisits =()=>lsGet('visits',[]),  setVisits =v=>lsSet('visits',v);
    const getPromos =()=>lsGet('promos',[]),  setPromos =v=>lsSet('promos',v);
    const getSales  =()=>lsGet('sales',[]),   setSales  =v=>lsSet('sales',v);
    const getSalesW =()=>lsGet('salesW',[]),  setSalesW =v=>lsSet('salesW',v);
    const getTours  =()=>lsGet('tours',[]),   setTours  =v=>lsSet('tours',v);
    const getFB =()=>lsGet('firebase',{}),    setFB =v=>lsSet('firebase',v);
    const tierToFreq=(t,s=getSettings())=>t==='importante'?s.freqImportant:(t==='nuovo'?s.freqNew:s.freqStandard);
    const nextId=(series)=>{const y=new Date().getFullYear();const c=lsGet('counters',{});const key=series+':'+y;const num=Number(c[key]||0)+1;c[key]=num;lsSet('counters',c);return series+'-'+y+'-'+String(num).padStart(3,'0')};

    function buildNav(active){
      const items=[['dashboard','Dashboard'],['clienti','Clienti'],['visite','Visite'],['promo','Promozioni'],['fatturati','Fatturati'],['agenda','Agenda'],['impostazioni','Impostazioni']];
      return items.map(([k,l]) => '<button data-route="'+k+'" class="w-full text-left px-3 py-2 rounded-xl text-sm '+(active===k?'bg-blue-50 text-blue-700 border border-blue-200':'hover:bg-slate-50')+'">'+l+'</button>').join('');
    }
    function openDrawer(open){ document.getElementById('drawer').classList.toggle('open', !!open); document.getElementById('scrim').classList.toggle('show', !!open); }
    const app=document.getElementById('app'); let route='dashboard', query='';
    function layout(){
      app.innerHTML=[
        '<div class="min-h-screen">',
          '<div class="no-print sticky top-0 z-20 bg-white/90 backdrop-blur border-b" style="padding:8px calc(16px + var(--safe-t))">',
            '<div class="max-w-7xl mx-auto flex items-center gap-3">',
              '<button id="burger" class="btn">☰</button>',
              '<div class="font-semibold">CRM Agente Lenti</div>',
              '<div class="flex-1"></div>',
              '<input id="q" placeholder="Cerca…" value="'+(query||'')+'" class="hidden md:block w-96 px-3 py-2 border rounded-xl text-sm border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">',
            '</div>',
          '</div>',
          '<div id="view" class="max-w-7xl mx-auto p-4 space-y-4"></div>',
        '</div>'
      ].join('');
      document.getElementById('nav').innerHTML=buildNav(route);
      document.querySelectorAll('#nav [data-route],#drawer [data-route]').forEach(b=>b.addEventListener('click',()=>{route=b.getAttribute('data-route'); openDrawer(false); render()}));
      document.getElementById('burger').addEventListener('click',()=>openDrawer(true));
      document.getElementById('scrim').addEventListener('click',()=>openDrawer(false));
      const q=document.getElementById('q'); if(q) q.addEventListener('input',e=>{query=e.target.value||'';render()});
    }
    function render(){layout();const root=document.getElementById('view'); if(route==='dashboard')return renderDashboard(root); if(route==='clienti')return renderClienti(root,query); if(route==='visite')return renderVisite(root); if(route==='promo')return renderPromo(root); if(route==='fatturati')return renderFatturati(root); if(route==='agenda')return renderAgenda(root); if(route==='impostazioni')return renderImpostazioni(root);}

    function lastSaleDateByClient(){
      const wm=getSalesW(); const mm=getSales();
      const map={};
      wm.forEach(w=>{ if(w.amount>0){ map[w.clientId]=(!map[w.clientId]||new Date(w.dateISO)>new Date(map[w.clientId]))? w.dateISO : map[w.clientId]; } });
      mm.forEach(m=>{ if(m.amount>0){ const dt=monthEnd(m.month).toISOString().slice(0,10); map[m.clientId]=(!map[m.clientId]||new Date(dt)>new Date(map[m.clientId]))? dt : map[m.clientId]; } });
      return map;
    }
    function renderDashboard(root){
      const clients=getClients(), visits=getVisits(), promos=getPromos(), sales=getSales();
      const month=yyyymm();
      const visitsMonth=visits.filter(v=>(v.date||'').startsWith(month)).length;
      const totalMonth=sales.filter(x=>x.month===month).reduce((a,b)=>a+Number(b.amount||0),0);
      const alerts=[];
      const lastSale=lastSaleDateByClient();
      clients.forEach(c=>{
        if(c.prepagatoRenewal){ const d=daysBetween(today(),c.prepagatoRenewal); if(d>=0&&d<=7) alerts.push({t:'carnet',txt:c.name+': carnet/prepagato in scadenza ('+fmtDate(c.prepagatoRenewal)+')'}); }
        const l=lastSale[c.id]; if(!l || daysBetween(l, today())>21) alerts.push({t:'fatturato', txt:c.name+': nessun fatturato negli ultimi 21 giorni'});
      });
      promos.forEach(p=>{ if(p.end){ const d=daysBetween(today(),p.end); if(d>=0&&d<=7) alerts.push({t:'promo',txt:'Promo "'+p.title+'" in scadenza ('+fmtDate(p.end)+')'}); } });
      const alertsHTML = alerts.length ? '<ul class="space-y-2 text-sm">'+alerts.map(a => '<li class="flex gap-2"><span class="pill '+(a.t==='promo'?'bg-amber-100 text-amber-700 border-amber-200':(a.t==='carnet'?'bg-emerald-100 text-emerald-700 border-emerald-200':'bg-red-100 text-red-700 border-red-200'))+'">'+a.t+'</span><span>'+a.txt+'</span></li>').join('')+'</ul>' : '<div class="text-slate-500 text-sm">Nessun avviso</div>';

      root.innerHTML=[
        '<div class="grid grid-cols-1 lg:grid-cols-4 gap-4">',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm">Clienti</div><div class="text-3xl font-bold">',clients.length,'</div></div></div>',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm">Visite mese</div><div class="text-3xl font-bold">',visitsMonth,'</div></div></div>',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm">Fatturato mese</div><div class="text-3xl font-bold">',fmtEuro(totalMonth),'</div></div></div>',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm mb-2">Avvisi</div>',alertsHTML,'</div></div>',
        '</div>'
      ].join('');
    }

    // (Altre sezioni uguali a v6: Clienti, Visite, Promo, Fatturati, Agenda - omesse qui per brevità nel commento)
  </script>
</body>
</html>

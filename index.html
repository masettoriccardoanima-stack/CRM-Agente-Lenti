<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>CRM Agente Lenti ‚Äì PWA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <style>
    :root{ --safe-b: env(safe-area-inset-bottom); --safe-t: env(safe-area-inset-top) }
    @media print { .no-print { display:none!important } body{ background:white!important } }
    body { background:#f8fafc; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .btn { padding:8px 12px; border-radius:12px; font-size:14px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
    .btn:hover { background:#f1f5f9; }
    .btn-primary { padding:8px 12px; border-radius:12px; font-size:14px; background:#2563eb; color:#fff; border:1px solid #1d4ed8; cursor:pointer; }
    .btn-primary:hover { background:#1d4ed8; }
    .card { background:#fff; border-radius:16px; border:1px solid #e2e8f0; box-shadow:0 1px 1px rgba(0,0,0,.02); }
    .card-h { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #f1f5f9; }
    .card-b { padding:16px; }
    .pill { border-radius:9999px; padding:2px 8px; border:1px solid #e2e8f0; font-size:12px; }
    #drawer{ position:fixed; top:0; bottom:0; left:0; width:280px; background:#fff; border-right:1px solid #e2e8f0; transform:translateX(-100%); transition:transform .2s ease; z-index:50; padding:12px; }
    #drawer.open{ transform:translateX(0) }
    #scrim{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; z-index:40 }
    #scrim.show{ display:block }
  </style>
</head>
<body>
  <div id="scrim" class="no-print"></div>
  <div id="drawer" class="no-print">
    <div class="text-lg font-bold mb-3">‚ò∞ Navigazione</div>
    <nav id="nav"></nav>
    <div class="mt-6 text-xs text-slate-500">Scorciatoie</div>
    <div class="mt-2 flex flex-wrap gap-2">
      <button class="btn" data-route="visite" data-s="quick">+ Visita</button>
      <button class="btn" data-route="fatturati" data-s="quick">+ Fatturato</button>
      <button class="btn" data-route="promo" data-s="quick">+ Promo</button>
    </div>
  </div>
  <div id="app"></div>
  <script>
    // ‚Äî‚Äî‚Äî Service worker ‚Äî‚Äî‚Äî
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.warn);
      });
    }

    // ‚Äî‚Äî‚Äî Helpers ‚Äî‚Äî‚Äî
    const lsGet=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
    const lsSet=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const fmtEuro=n=>(Number(n)||0).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
    const fmtDate=s=>s?new Date(s).toLocaleDateString('it-IT'):'';
    const today=()=>new Date().toISOString().slice(0,10);
    const yyyymm=()=>new Date().toISOString().slice(0,7);
    const addDays=(iso,days)=>{const d=new Date(iso||today());d.setDate(d.getDate()+Number(days||0));return d.toISOString().slice(0,10)};
    const daysBetween=(a,b)=>{const A=new Date(a),B=new Date(b);return Math.round((B-A)/(1000*60*60*24))};
    const monthStart=(ym)=> new Date(ym+'-01');
    const monthEnd=(ym)=> new Date(new Date(ym+'-01').getFullYear(), new Date(ym+'-01').getMonth()+1, 0);
    function isoWeekStart(year, week){
      const simple = new Date(year,0,1+ (week-1)*7);
      const dow = simple.getDay(); const ISOweekStart = simple;
      const diff = (dow<=4 ? 1-dow : 8-dow);
      ISOweekStart.setDate(simple.getDate()+diff);
      return ISOweekStart;
    }

    /* ============== Firebase helpers (single, canonical) ============== */

async function ensureFirebaseConnected(){
  const fb = getFB();
  if(!fb.enabled || !fb.config || !fb.agentId) return false;

  await loadFirebaseCDN();
  if(!window._fbApp){
    window._fbApp  = firebase.initializeApp(fb.config);
    window._fbAuth = firebase.auth();
    window._fbDB   = firebase.firestore();
  }

  if(window._fbAuth.currentUser) return true;

  if((fb.authMode||'anon') === 'password'){
    const pass = document.getElementById('fbPass')?.value || window._fbPassword || '';
    if(!fb.email || !pass) return false; // niente fallback automatico
    await window._fbAuth.signInWithEmailAndPassword(fb.email, pass);
  } else {
    await window._fbAuth.signInAnonymously();
  }
  return !!window._fbDB;
}
/* ============== fine Firebase helpers ============== */

// === Defaults (unico, sicuro anche se ricaricato) ===
var DEF_SETTINGS = window.DEF_SETTINGS || {
  agencyName: 'Marinelli Optodinamica ‚Äì Agente',
  agentName: 'Agente Demo',
  baseCity: 'Padova',
  freqStandard: 90,
  freqImportant: 30,
  freqNew: 21,
  annualGoal: 130000
};
window.DEF_SETTINGS = DEF_SETTINGS;

// Alias retrocompatibile (se qualche punto usa ancora DEFAULT_SETTINGS)
var DEFAULT_SETTINGS = window.DEFAULT_SETTINGS || DEF_SETTINGS;
window.DEFAULT_SETTINGS = DEFAULT_SETTINGS;

// Compatibilit√† retro: se qualche punto usa ancora DEFAULT_SETTINGS
// l'alias evita ReferenceError.
const DEFAULT_SETTINGS = DEF_SETTINGS;

    
    const TRIVENETO={ 'Veneto':['PD','VE','TV','VI','VR','RO','BL'], 'Trentino-Alto Adige/S√ºdtirol':['TN','BZ'], 'Friuli Venezia Giulia':['TS','GO','PN','UD'] };
    
    function ensureSeeds(){
      if(!lsGet('settings')) lsSet('settings', DEF_SETTINGS);
      if(!lsGet('clients')?.length) lsSet('clients',[
        {id:'C-001',code:'OTT-PD',name:'Ottica Prato della Valle',contact:'Giulia',phone:'049...',email:'pd@ottica.it',address:'Prato della Valle 1, Padova',city:'Padova',prov:'PD',region:'Veneto',status:'attivo',tier:'importante',goalMonthly:3000,prepagatoRenewal:'',lastVisitDate:'',nextVisitDate:'',notes:''},
        {id:'C-002',code:'OTT-VE',name:'Ottica Rialto',contact:'Luca',phone:'041...',email:'ve@ottica.it',address:'San Polo 100, Venezia',city:'Venezia',prov:'VE',region:'Veneto',status:'lead',tier:'nuovo',goalMonthly:1500,prepagatoRenewal:'',lastVisitDate:'',nextVisitDate:'',notes:'Interessati a progressive'}
      ]);
      if(!lsGet('visits')) lsSet('visits',[]);
      if(!lsGet('promos')) lsSet('promos',[]);
      if(!lsGet('cPromos')) lsSet('cPromos',[]);
      if(!lsGet('sync')) lsSet('sync',{lastSyncISO:''});
      if(!lsGet('sales')) lsSet('sales',[]);
      if(!lsGet('salesW')) lsSet('salesW',[]);
      if(!lsGet('tours')) lsSet('tours',[]);
      if(!lsGet('firebase')) lsSet('firebase',{enabled:false, config:null, agentId:''});
    }
    ensureSeeds();

    // ‚Äî‚Äî‚Äî Data accessors ‚Äî‚Äî‚Äî
    const getSettings = () => lsGet('settings', DEF_SETTINGS);
    const setSettings=v=>lsSet('settings',v);
    const getClients=()=>lsGet('clients',[]), setClients=v=>lsSet('clients',v);
    const getVisits =()=>lsGet('visits',[]),  setVisits =v=>lsSet('visits',v);
    const getPromos =()=>lsGet('promos',[]),  setPromos =v=>lsSet('promos',v);
    const getSales  =()=>lsGet('sales',[]),   setSales  =v=>lsSet('sales',v);
    const getSalesW =()=>lsGet('salesW',[]),  setSalesW =v=>lsSet('salesW',v);
    const getTours  =()=>lsGet('tours',[]),   setTours  =v=>lsSet('tours',v);
    const getFB =()=>lsGet('firebase',{}),    setFB =v=>lsSet('firebase',v);
    const getCPromos=()=>lsGet('cPromos',[]), setCPromos=v=>lsSet('cPromos',v);
    const getSync=()=>lsGet('sync',{lastSyncISO:''}), setSync=v=>lsSet('sync',v);

    const tierToFreq=(t,s=getSettings())=>t==='importante'?s.freqImportant:(t==='nuovo'?s.freqNew:s.freqStandard);
    const nextId=(series)=>{const y=new Date().getFullYear();const c=lsGet('counters',{});const key=series+':'+y;const num=Number(c[key]||0)+1;c[key]=num;lsSet('counters',c);return series+'-'+y+'-'+String(num).padStart(3,'0')};

    // ‚Äî‚Äî‚Äî Drawer & shell ‚Äî‚Äî‚Äî
    function buildNav(active){
      const items=[['dashboard','Dashboard'],['clienti','Clienti'],['visite','Visite'],['promo','Promozioni'],['fatturati','Fatturati'],['agenda','Agenda'],['impostazioni','Impostazioni']];
      return items.map(([k,l]) => '<button data-route="'+k+'" class="w-full text-left px-3 py-2 rounded-xl text-sm '+(active===k?'bg-blue-50 text-blue-700 border border-blue-200':'hover:bg-slate-50')+'">'+l+'</button>').join('');
    }
    function openDrawer(open){ document.getElementById('drawer').classList.toggle('open', !!open); document.getElementById('scrim').classList.toggle('show', !!open); }

    const app=document.getElementById('app'); let route='dashboard', query='';
    window._openClientId = null;
    function layout(){
      app.innerHTML=[
        '<div class="min-h-screen">',
          '<div class="no-print sticky top-0 z-20 bg-white/90 backdrop-blur border-b" style="padding:8px calc(16px + var(--safe-t))">',
            '<div class="max-w-7xl mx-auto flex items-center gap-3">',
              '<button id="burger" class="btn">‚ò∞</button>',
              '<div class="font-semibold">CRM Agente Lenti</div>',
              '<div class="flex-1"></div>',
              '<input id="q" placeholder="Cerca‚Ä¶" value="'+(query||'')+'" class="hidden md:block w-96 px-3 py-2 border rounded-xl text-sm border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">',
            '</div>',
          '</div>',
          '<div id="view" class="max-w-7xl mx-auto p-4 space-y-4"></div>',
        '</div>'
      ].join('');
      document.getElementById('nav').innerHTML=buildNav(route);
      document.querySelectorAll('#nav [data-route],#drawer [data-route]').forEach(b=>b.addEventListener('click',()=>{route=b.getAttribute('data-route'); openDrawer(false); render()}));
      document.getElementById('burger').addEventListener('click',()=>openDrawer(true));
      document.getElementById('scrim').addEventListener('click',()=>openDrawer(false));
      const q=document.getElementById('q'); if(q) q.addEventListener('input',e=>{query=e.target.value||'';render()});
    }
    function render(){
      layout();
      const root=document.getElementById('view');
      if(route==='dashboard') return renderDashboard(root);
      if(route==='clienti')   return renderClienti(root,query);
      if(route==='visite')    return renderVisite(root);
      if(route==='promo')     return renderPromo(root);
      if(route==='fatturati') return renderFatturati(root);
      if(route==='agenda')    return renderAgenda(root);
      if(route==='impostazioni') return renderImpostazioni(root);
      if(route==='cliente')   return renderCliente(root, window._openClientId);
    }

    // ‚Äî‚Äî‚Äî Dashboard ‚Äî‚Äî‚Äî
    function lastSaleDateByClient(){
      const wm=getSalesW(); const mm=getSales();
      const map={};
      wm.forEach(w=>{ if(w.amount>0){ map[w.clientId]=(!map[w.clientId]||new Date(w.dateISO)>new Date(map[w.clientId]))? w.dateISO : map[w.clientId]; } });
      mm.forEach(m=>{ if(m.amount>0){ const dt=monthEnd(m.month).toISOString().slice(0,10); map[m.clientId]=(!map[m.clientId]||new Date(dt)>new Date(map[m.clientId]))? dt : map[m.clientId]; } });
      return map;
    }
    function renderDashboard(root){
      const clients=getClients(), visits=getVisits(), promoCatalog=getPromos(), sales=getSales();
      const month=yyyymm();

      // KPI
      const visitsMonth=visits.filter(v=>(v.date||'').startsWith(month)).length;
      const totalMonth=sales.filter(x=>x.month===month).reduce((a,b)=>a+Number(b.amount||0),0);

      // Alert scadenze PROMO
      const cPromos=getCPromos();
      const alerts=[];
      cPromos.forEach(cp=>{
        if(cp.end){
          const d=daysBetween(today(), cp.end);
          if(d>=0 && d<=7){
            const cli=clients.find(c=>c.id===cp.clientId);
            alerts.push({t:'promo',txt:(cli?cli.name:'Cliente')+': promo "'+cp.title+'" in scadenza ('+fmtDate(cp.end)+')'});
          }
        }
      });

      const alertsHTML = alerts.length
        ? '<ul class="space-y-2 text-sm">'+alerts.map(a =>
            '<li class="flex gap-2"><span class="pill bg-amber-100 text-amber-700 border-amber-200">'+a.t+'</span><span>'+a.txt+'</span></li>'
          ).join('')+'</ul>'
        : '<div class="text-slate-500 text-sm">Nessun avviso</div>';

      const lastSyncBadge = getSync().lastSyncISO
        ? '<span class="pill bg-emerald-50 text-emerald-700 border-emerald-200">Cloud: '+new Date(getSync().lastSyncISO).toLocaleString('it-IT')+'</span>'
        : '<span class="pill bg-slate-50 text-slate-600 border-slate-200">Cloud: mai</span>';

      // Top 10 da visitare
      const s=getSettings();
      const tierToFreqLocal=(t)=>t==='importante'?s.freqImportant:(t==='nuovo'?s.freqNew:s.freqStandard);
      const dueScore = (c)=>{
        const nextDefault=c.nextVisitDate||(c.lastVisitDate?addDays(c.lastVisitDate, tierToFreqLocal(c.tier||'standard')):'');
        const daysLate = nextDefault ? Math.max(0, daysBetween(nextDefault, today())) : 9999;
        const weight = c.tier==='importante'?2:(c.tier==='nuovo'?1.5:1);
        return daysLate*weight;
      };
      const top10 = [...clients].sort((a,b)=>dueScore(b)-dueScore(a)).slice(0,10);

      root.innerHTML=[
        '<div class="grid grid-cols-1 lg:grid-cols-4 gap-4">',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm">Clienti</div><div class="text-3xl font-bold">',clients.length,'</div></div></div>',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm">Visite mese</div><div class="text-3xl font-bold">',visitsMonth,'</div></div></div>',
          '<div class="card"><div class="card-b"><div class="text-slate-500 text-sm">Fatturato mese</div><div class="text-3xl font-bold">',fmtEuro(totalMonth),'</div></div></div>',
          '<div class="card"><div class="card-b flex items-center justify-between"><div><div class="text-slate-500 text-sm mb-2">Stato cloud</div>',lastSyncBadge,'</div><button id="quickSync" class="btn">Sync rapido</button></div></div>',
        '</div>',
        '<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">',
          '<div class="card"><div class="card-h"><h3 class="font-semibold">Avvisi</h3></div><div class="card-b">',alertsHTML,'</div></div>',
          '<div class="card"><div class="card-h"><h3 class="font-semibold">Top 10 da visitare</h3></div><div class="card-b">',
            top10.length?('<ul class="text-sm space-y-2">'+top10.map(c=>'<li><span class="font-medium">'+c.name+'</span> ‚Äî tier: '+(c.tier||'standard')+' ¬∑ prossima: '+(c.nextVisitDate?fmtDate(c.nextVisitDate):'‚Äì')+' <button class="btn" data-qv="'+c.id+'">+ visita rapida</button></li>').join('')+'</ul>'):'<div class="text-slate-500 text-sm">‚Äî</div>',
          '</div></div>',
        '</div>'
      ].join('');

      // quick visit
      root.querySelectorAll('[data-qv]').forEach(b=>b.addEventListener('click',()=>{ registerQuickVisit(b.getAttribute('data-qv')); renderDashboard(root); }));

      // quick sync
      const qs=root.querySelector('#quickSync');
      if(qs) qs.addEventListener('click', async ()=>{
        const ok = await ensureFirebaseConnected();
        if(!ok){ alert('Connettiti prima in Impostazioni ‚Üí Sincronizzazione'); return; }
        const fb=getFB();
        const docRef=window._fbDB.collection('agents').doc(fb.agentId).collection('data').doc('v1');
        const payload={settings:getSettings(),clients:getClients(),visits:getVisits(),promos:getPromos(),
                       sales:getSales(),salesW:getSalesW(),tours:getTours(),cPromos:getCPromos(),ts:new Date().toISOString()};
        await docRef.set(payload);
        setSync({lastSyncISO:new Date().toISOString()});
        alert('Sync ok');
        renderDashboard(root);
      });
    }

    // ‚Äî‚Äî‚Äî Clienti ‚Äî‚Äî‚Äî
    function renderClienti(root,q){
      window._uiClient = window._uiClient || {showNew:false, showImport:false};
      const sortKeyLS='clientiSort';
      let sortState = lsGet(sortKeyLS, {key:'name', dir:'asc'});
      const saveSort = (s)=>{ sortState=s; lsSet(sortKeyLS,s); };

      let clients=getClients();
      const s=getSettings();

      const tiers=['nuovo','standard','importante'];

      const norm=(x)=>String(x||'').toLowerCase();
      const dateVal=(d)=> d ? new Date(d).getTime() : 0;
      const cmp=(a,b,dir)=> dir==='asc' ? (a>b?1:(a<b?-1:0)) : (a<b?1:(a>b?-1:0));

      function filtered(){
        if(!q) return clients;
        const qq=norm(q);
        return clients.filter(c=> norm(JSON.stringify(c)).includes(qq) );
      }

      function row(c){
        const tiers=['nuovo','standard','importante'];
        const s=getSettings();
        const overdue = c.lastVisitDate && new Date(addDays(c.lastVisitDate, tierToFreq(c.tier||'standard',s))) < new Date(today());
        const tierSel = '<select class="border rounded-xl px-2 py-1 text-sm" data-tier="'+c.id+'">'+
          tiers.map(t=>'<option value="'+t+'" '+(t===(c.tier||'standard')?'selected':'')+'>'+t+'</option>').join('')+
        '</select>';

        return [
          '<tr class="border-b align-top">',
            '<td class="px-2 py-2 font-mono">', c.code||'', '</td>',
            '<td class="px-2 py-2">',
              '<button class="font-medium underline decoration-dotted" data-open="',c.id,'">', c.name ,'</button>',
              '<div class="text-xs text-slate-500">', (c.contact||''), '</div>',
            '</td>',
            '<td class="px-2 py-2">', (c.city||''), ' (', (c.prov||''), ')</td>',
            '<td class="px-2 py-2">', tierSel ,'</td>',
            '<td class="px-2 py-2 ', (overdue?'text-red-600 font-semibold':''), '">', fmtDate(c.lastVisitDate) ,'</td>',
            '<td class="px-2 py-2 text-right whitespace-nowrap">',
              '<button class="btn" data-qv="',c.id,'">+ Visita</button> ',
              '<button class="btn" data-notes="',c.id,'">Note</button> ',
              '<button class="btn" data-promo="',c.id,'">Promo</button> ',
              '<button class="btn text-red-600 border-red-300 hover:bg-red-50" data-del="',c.id,'">Elimina</button>',
            '</td>',
          '</tr>',

          (window._openClientId===c.id ? (
            '<tr class="bg-slate-50"><td colspan="6" class="px-3 py-3 text-sm">'+[
              '<div class="grid grid-cols-1 md:grid-cols-3 gap-3">',
                '<div><div class="text-slate-500 text-xs">Indirizzo</div><div>', c.address||'‚Äî','</div></div>',
                '<div><div class="text-slate-500 text-xs">Email</div><div>', c.email||'‚Äî','</div></div>',
                '<div><div class="text-slate-500 text-xs">Telefono</div><div>', c.phone||'‚Äî','</div></div>',
                '<div><div class="text-slate-500 text-xs">Pagamento</div><div>', c.paymentDesc||'‚Äî','</div></div>',
                '<div><div class="text-slate-500 text-xs">Listino</div><div>', (c.priceCode||'‚Äî'),' ', (c.priceDesc||''),'</div></div>',
                '<div><div class="text-slate-500 text-xs">Note</div><div>', c.notes||'‚Äî','</div></div>',
              '</div>',
              '<div class="mt-3 flex items-center justify-between">',
                '<div class="text-xs text-slate-600">Ultima visita: ',(fmtDate(c.lastVisitDate)||'‚Äî'),' ¬∑ Prossima: ',(fmtDate(c.nextVisitDate)||'‚Äî'),'</div>',
                '<div class="space-x-2">',
                  '<button class="btn" data-full="',c.id,'">Anagrafica completa ‚Üí</button>',
                '</div>',
              '</div>'
            ].join('')+'</td></tr>'
          ):'')
        ].join('');
      }

      function paint(){
        const list=[...filtered()];

        // sorting
        list.sort((A,B)=>{
          const k=sortState.key, d=sortState.dir;
          if(k==='name') return cmp(norm(A.name), norm(B.name), d);
          if(k==='tier') return cmp(norm(A.tier||'standard'), norm(B.tier||'standard'), d);
          if(k==='last') return cmp(dateVal(A.lastVisitDate), dateVal(B.lastVisitDate), d);
          return 0;
        });

        root.innerHTML=[
          '<div class="space-y-4">',

            '<div class="flex items-center justify-between">',
              '<button id="btnNew" class="btn">+ Nuovo cliente</button>',
              '<button id="btnImport" class="btn">‚¨ÜÔ∏è Import</button>',
            '</div>',

            (window._uiClient.showNew?[
            '<div class="card"><div class="card-h"><h3 class="font-semibold">Nuovo cliente</h3></div>',
              '<div class="card-b">',
              '<form id="fNew" class="grid grid-cols-1 md:grid-cols-6 gap-3">',
                '<input class="border rounded-xl px-3 py-2" name="code" placeholder="Codice">',
                '<input class="border rounded-xl px-3 py-2 md:col-span-2" name="name" placeholder="Ragione sociale">',
                '<input class="border rounded-xl px-3 py-2" name="piva" placeholder="P.IVA">',
                '<input class="border rounded-xl px-3 py-2" name="contact" placeholder="Contatto">',
                '<input class="border rounded-xl px-3 py-2" name="phone" placeholder="Telefono">',
                '<input class="border rounded-xl px-3 py-2" name="email" placeholder="Email">',
                '<input class="border rounded-xl px-3 py-2 md:col-span-3" name="address" placeholder="Indirizzo">',
                '<input class="border rounded-xl px-3 py-2" name="city" placeholder="Citt√†">',
                '<select class="border rounded-xl px-3 py-2" name="prov">',Object.values(TRIVENETO).flat().map(p=>'<option>'+p+'</option>').join(''),'</select>',
                '<select class="border rounded-xl px-3 py-2" name="region">',Object.keys(TRIVENETO).map(r=>'<option>'+r+'</option>').join(''),'</select>',
                '<select class="border rounded-xl px-3 py-2" name="status">',['lead','attivo','sospeso','perso'].map(s=>'<option>'+s+'</option>').join(''),'</select>',
                '<select class="border rounded-xl px-3 py-2" name="tier">',tiers.map(t=>'<option>'+t+'</option>').join(''),'</select>',
                '<input class="border rounded-xl px-3 py-2" type="number" step="0.01" name="goalMonthly" placeholder="Obiettivo ‚Ç¨ mensile">',
                '<input class="border rounded-xl px-3 py-2" type="date" name="prepagatoRenewal" placeholder="Rinnovo carnet/prepagato">',
                '<div class="md:col-span-6"><textarea class="border rounded-xl px-3 py-2 w-full" name="notes" placeholder="Note cliente"></textarea></div>',
                '<div class="md:col-span-6 text-right"><button class="btn-primary">Aggiungi</button></div>',
              '</form>',
              '</div></div>'
            ].join(''):''),
            
            (window._uiClient.showImport?[
            '<div class="card"><div class="card-h"><h3 class="font-semibold">Import clienti (CSV)</h3></div>',
              '<div class="card-b grid grid-cols-1 md:grid-cols-6 gap-3">',
                '<input id="fileClients" type="file" accept=".csv,text/csv" class="md:col-span-3">',
                '<div class="md:col-span-3 text-right"><button id="importClients" class="btn">Importa</button></div>',
                '<div class="md:col-span-6 text-xs text-slate-500">',
                  'Intestazioni riconosciute: Codice Cliente, Ragione Sociale/Cliente, Indirizzo, Citt√†/Localit√†, CAP, Provincia, Codice Fiscale, Partita IVA, Persona di Riferimento, Email, Telefono, Des. Pagamento, Cod. Listino.',
                '</div>',
              '</div>',
            '</div>'
            ].join(''):''),
            
            '<div class="card"><div class="card-h"><h3 class="font-semibold">Elenco clienti</h3></div>',
              '<div class="card-b overflow-auto">',
                '<table class="min-w-full text-sm"><thead class="bg-slate-100 text-slate-600"><tr>',
                  '<th class="text-left px-2 py-2">Codice</th>',
                  '<th class="text-left px-2 py-2 cursor-pointer" data-sort="name">Cliente</th>',
                  '<th class="text-left px-2 py-2">Localit√†</th>',
                  '<th class="text-left px-2 py-2 cursor-pointer" data-sort="tier">Tier</th>',
                  '<th class="text-left px-2 py-2 cursor-pointer" data-sort="last">Ult. visita</th>',
                  '<th class="px-2 py-2"></th>',
                '</tr></thead><tbody>',
                  list.map(row).join(''),
                '</tbody></table>',
              '</div>',
            '</div>',
          '</div>'
        ].join('');

        // Toggle
        const bNew=root.querySelector('#btnNew');
        const bImp=root.querySelector('#btnImport');
        if(bNew) bNew.addEventListener('click', ()=>{ window._uiClient.showNew=!window._uiClient.showNew; paint(); });
        if(bImp) bImp.addEventListener('click', ()=>{ window._uiClient.showImport=!window._uiClient.showImport; paint(); });

        // Submit nuovo
        const f=root.querySelector('#fNew');
        if(f) f.addEventListener('submit',e=>{
          e.preventDefault();
          const data=Object.fromEntries(new FormData(f).entries());
          const c={id:'C-'+Date.now(),...data,goalMonthly:Number(data.goalMonthly||0),lastVisitDate:'',nextVisitDate:'',notes:data.notes||''};
          const all=[c, ...clients]; setClients(all); clients=all; window._uiClient.showNew=false; paint();
        });

        // Import CSV
        const btnIC=root.querySelector('#importClients');
        if(btnIC){
          btnIC.addEventListener('click', async ()=>{
            const f = root.querySelector('#fileClients').files?.[0];
            if(!f){ alert('Seleziona un CSV'); return; }
            const text = await f.text();
            const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
            if(!lines.length){ alert('CSV vuoto'); return; }
            const sep = lines[0].includes(';') ? ';' : ',';
            const header = lines[0].split(sep).map(h=>h.trim());
            const normH = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
            const Hmap = Object.fromEntries(header.map((h,i)=>[normH(h), i]));
            const idx = (...aliases)=>{ for(const a of aliases){ const i=Hmap[normH(a)]; if(i!=null) return i; } return -1; };
            const ix = {
              code:      idx('Codice Cliente','Codice'),
              name:      idx('Ragione Sociale','Cliente'),
              address:   idx('Indirizzo'),
              cap:       idx('CAP'),
              city:      (()=>{ for (const [k,i] of Object.entries(Hmap)){ if(/^localit/.test(k)||k==='citt√†'||k==='citta') return i; } return -1; })(),
              prov:      idx('Provincia'),
              cf:        idx('Codice Fiscale'),
              piva:      idx('Partita IVA','P.IVA','Partita Iva'),
              contact:   idx('Persona Di Riferimento','Referente'),
              email:     idx('Indirizzo email','Email'),
              phone:     idx('Telefono'),
              payDesc:   idx('Des. Pagamento','Descrizione Pagamento','Pagamento'),
              priceCode: idx('Cod. Listino','Codice Listino'),
              priceDesc: idx('Des. Listino','Descrizione Listino'),
            };
            if(ix.code<0 && ix.name<0){ alert('CSV non riconosciuto: serve almeno "Codice Cliente" o "Ragione Sociale"'); return; }
            let list = getClients(); let added=0, updated=0;
            for(let r=1; r<lines.length; r++){
              const cols = lines[r].split(sep);
              const code = ix.code>=0 ? (cols[ix.code]||'').trim() : '';
              const name = ix.name>=0 ? (cols[ix.name]||'').trim() : '';
              if(!code && !name) continue;
              let cli = list.find(x => (code && x.code===code))
                      || list.find(x => (ix.piva>=0 && (cols[ix.piva]||'').trim() && x.piva && x.piva.trim().toLowerCase()===(cols[ix.piva]||'').trim().toLowerCase()))
                      || list.find(x => (name && x.name && x.name.trim().toLowerCase()===name.toLowerCase()));
              const patch = {
                code,name,
                address:    ix.address>=0 ? (cols[ix.address]||'').trim() : (cli?.address||''),
                cap:        ix.cap>=0 ? (cols[ix.cap]||'').trim() : (cli?.cap||''),
                city:       ix.city>=0 ? (cols[ix.city]||'').trim() : (cli?.city||''),
                prov:       ix.prov>=0 ? (cols[ix.prov]||'').trim() : (cli?.prov||''),
                cf:         ix.cf>=0 ? (cols[ix.cf]||'').trim() : (cli?.cf||''),
                piva:       ix.piva>=0 ? (cols[ix.piva]||'').trim() : (cli?.piva||''),
                contact:    ix.contact>=0 ? (cols[ix.contact]||'').trim() : (cli?.contact||''),
                email:      ix.email>=0 ? (cols[ix.email]||'').trim() : (cli?.email||''),
                phone:      ix.phone>=0 ? (cols[ix.phone]||'').trim() : (cli?.phone||''),
                paymentDesc:ix.payDesc>=0 ? (cols[ix.payDesc]||'').trim() : (cli?.paymentDesc||''),
                priceCode:  ix.priceCode>=0 ? (cols[ix.priceCode]||'').trim() : (cli?.priceCode||''),
                priceDesc:  ix.priceDesc>=0 ? (cols[ix.priceDesc]||'').trim() : (cli?.priceDesc||''),
              };
              if(cli){ Object.assign(cli, patch); updated++; }
              else{
                list.push({ id:'C-'+Date.now()+Math.random().toString(36).slice(2,7), ...patch, tier:'standard', status:'attivo', goalMonthly:0, lastVisitDate:'', nextVisitDate:'', notes:'' });
                added++;
              }
            }
            setClients(list); clients=list;
            alert('Clienti importati: '+added+' ‚Äî aggiornati: '+updated);
            window._uiClient.showImport=false; paint();
          });
        }

        // azioni riga
        root.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
          const id=b.getAttribute('data-del');
          if(confirm('Eliminare cliente?')){ clients=clients.filter(x=>x.id!==id); setClients(clients); paint(); }
        }));
        root.querySelectorAll('[data-qv]').forEach(b=>b.addEventListener('click',()=>{
          const id=b.getAttribute('data-qv'); registerQuickVisit(id); clients=getClients(); paint();
        }));
        root.querySelectorAll('[data-notes]').forEach(b=>b.addEventListener('click',()=>{
          const id=b.getAttribute('data-notes'); const all=getClients(); const c=all.find(x=>x.id===id);
          const n=prompt('Note cliente:', c.notes||''); if(n!=null){ c.notes=n; setClients(all); alert('Note salvate'); }
        }));
        root.querySelectorAll('[data-promo]').forEach(b=>b.addEventListener('click',()=>{
          window._promoClientPreselect = b.getAttribute('data-promo'); route='promo'; render();
        }));
        
        // apri/chiudi mini riassunto
        root.querySelectorAll('[data-open]').forEach(b=>b.addEventListener('click',()=>{
          const id=b.getAttribute('data-open');
          window._openClientId = (window._openClientId===id ? null : id);
          paint();
        }));

        // vai alla scheda completa
        root.querySelectorAll('[data-full]').forEach(b=>b.addEventListener('click',()=>{
          window._openClientId = b.getAttribute('data-full');
          route='cliente';
          render();
        }));

        // edit tier
        root.querySelectorAll('[data-tier]').forEach(sel=>sel.addEventListener('change',()=>{
          const id=sel.getAttribute('data-tier'); const all=getClients(); const c=all.find(x=>x.id===id); if(c){ c.tier=sel.value; setClients(all); }
        }));
        // sort
        root.querySelectorAll('[data-sort]').forEach(th=>th.addEventListener('click',()=>{
          const key=th.getAttribute('data-sort');
          const dir=(sortState.key===key && sortState.dir==='asc')?'desc':'asc';
          saveSort({key,dir}); paint();
        }));
      }

      paint();
    }

    function renderCliente(root, id){
      const all = getClients();
      const c = all.find(x=>x.id===id);
      if(!c){ root.innerHTML='<div class="card"><div class="card-b">Cliente non trovato</div></div>'; return; }

      const provOpts = Object.values(TRIVENETO).flat()
        .map(p=>'<option value="'+p+'" '+(p===(c.prov||'')?'selected':'')+'>'+p+'</option>').join('');

      root.innerHTML = [
        '<div class="space-y-4">',
          '<div class="card"><div class="card-h">',
            '<h3 class="font-semibold">Scheda cliente</h3>',
            '<div><button id="back" class="btn">‚Üê Indietro</button></div>',
          '</div>',
          '<div class="card-b">',
            '<form id="fCli" class="grid grid-cols-1 md:grid-cols-6 gap-3">',
              '<input class="border rounded-xl px-3 py-2" name="code" value="'+(c.code||'')+'" placeholder="Codice">',
              '<input class="border rounded-xl px-3 py-2 md:col-span-2" name="name" value="'+(c.name||'')+'" placeholder="Ragione sociale">',
              '<input class="border rounded-xl px-3 py-2" name="piva" value="'+(c.piva||'')+'" placeholder="Partita IVA">',
              '<input class="border rounded-xl px-3 py-2" name="cf" value="'+(c.cf||'')+'" placeholder="Codice Fiscale">',
              '<input class="border rounded-xl px-3 py-2" name="contact" value="'+(c.contact||'')+'" placeholder="Persona di riferimento">',
              '<input class="border rounded-xl px-3 py-2" name="phone" value="'+(c.phone||'')+'" placeholder="Telefono">',
              '<input class="border rounded-xl px-3 py-2 md:col-span-3" name="email" value="'+(c.email||'')+'" placeholder="Email">',
              '<input class="border rounded-xl px-3 py-2 md:col-span-3" name="address" value="'+(c.address||'')+'" placeholder="Indirizzo">',
              '<input class="border rounded-xl px-3 py-2" name="cap" value="'+(c.cap||'')+'" placeholder="CAP">',
              '<input class="border rounded-xl px-3 py-2" name="city" value="'+(c.city||'')+'" placeholder="Localit√†">',
              '<select class="border rounded-xl px-3 py-2" name="prov">'+provOpts+'</select>',
              '<input class="border rounded-xl px-3 py-2" name="region" value="'+(c.region||'')+'" placeholder="Regione">',
              '<select class="border rounded-xl px-3 py-2" name="status">'+['lead','attivo','sospeso','perso'].map(s=>'<option '+(s===(c.status||'attivo')?'selected':'')+'>'+s+'</option>').join('')+'</select>',
              '<select class="border rounded-xl px-3 py-2" name="tier">'+['nuovo','standard','importante'].map(t=>'<option '+(t===(c.tier||'standard')?'selected':'')+'>'+t+'</option>').join('')+'</select>',
              '<input class="border rounded-xl px-3 py-2" type="number" step="0.01" name="goalMonthly" value="'+(c.goalMonthly||0)+'" placeholder="Obiettivo ‚Ç¨ mensile">',
              '<input class="border rounded-xl px-3 py-2" name="paymentDesc" value="'+(c.paymentDesc||'')+'" placeholder="Des. pagamento">',
              '<input class="border rounded-xl px-3 py-2" list="listini" name="priceCode" value="'+(c.priceCode||'')+'" placeholder="Codice listino (CF0, VIP, VPS)">',
              '<datalist id="listini"><option value="CF0"><option value="VIP"><option value="VPS"></datalist>',
              '<input class="border rounded-xl px-3 py-2 md:col-span-3" name="priceDesc" value="'+(c.priceDesc||'')+'" placeholder="Descrizione listino (opz.)">',
              '<div class="md:col-span-6"><textarea class="border rounded-xl px-3 py-2 w-full" name="notes" placeholder="Note">'+(c.notes||'')+'</textarea></div>',
              '<div class="md:col-span-6 flex items-center justify-between">',
                '<div class="text-xs text-slate-600">Ultima visita: '+(fmtDate(c.lastVisitDate)||'‚Äî')+' ¬∑ Prossima: '+(fmtDate(c.nextVisitDate)||'‚Äî')+'</div>',
                '<div class="space-x-2">',
                  '<button type="button" id="quickVisit" class="btn">+ Visita rapida</button>',
                  '<button type="button" id="del" class="btn text-red-600 border-red-300 hover:bg-red-50">Elimina</button>',
                  '<button class="btn-primary">Salva</button>',
                '</div>',
              '</div>',
            '</form>',
          '</div></div>',
        '</div>'
      ].join('');

      document.getElementById('back').addEventListener('click', ()=>{ route='clienti'; render(); });

      document.getElementById('fCli').addEventListener('submit', e=>{
        e.preventDefault();
        const form = Object.fromEntries(new FormData(e.target).entries());
        Object.assign(c, {
          code:form.code, name:form.name, piva:form.piva, cf:form.cf,
          contact:form.contact, phone:form.phone, email:form.email,
          address:form.address, cap:form.cap, city:form.city, prov:form.prov, region:form.region,
          status:form.status, tier:form.tier, goalMonthly:Number(form.goalMonthly||0),
          paymentDesc:form.paymentDesc, priceCode:form.priceCode, priceDesc:form.priceDesc,
          notes:form.notes
        });
        setClients(all);
        alert('Cliente salvato');
      });

      document.getElementById('quickVisit').addEventListener('click', ()=>{
        registerQuickVisit(c.id);
        renderCliente(root, id);
      });

      document.getElementById('del').addEventListener('click', ()=>{
        if(confirm('Eliminare cliente?')){
          setClients(all.filter(x=>x.id!==id));
          route='clienti'; render();
        }
      });
    }

    // ‚Äî‚Äî‚Äî Visite ‚Äî‚Äî‚Äî
    function renderVisite(root){
      const clients=getClients(); let visits=getVisits();
      function rows(){ return visits.map(v => ['<tr class="border-b">',
        '<td class="px-2 py-2 font-mono">',v.id,'</td>',
        '<td class="px-2 py-2">',fmtDate(v.date),'</td>',
        '<td class="px-2 py-2">',(clients.find(c=>c.id===v.clientId)||{}).name||'‚Äî','</td>',
        '<td class="px-2 py-2">',v.reason,'</td>',
        '<td class="px-2 py-2">',v.esito,'</td>',
        '<td class="px-2 py-2">',fmtDate(v.nextDate),'</td>',
        '<td class="px-2 py-2">',v.notes||'', '</td>',
        '<td class="px-2 py-2 text-right"><button class="btn text-red-600 border-red-300 hover:bg-red-50" data-del="',v.id,'">Elimina</button></td>',
      '</tr>'].join('')).join(''); }
      root.innerHTML=[
        '<div class="space-y-4">',
          '<div class="card"><div class="card-h"><h3 class="font-semibold">Registra visita</h3></div>',
          '<div class="card-b">',
            '<form id="fVisit" class="grid grid-cols-1 md:grid-cols-6 gap-3">',
              '<input class="border rounded-xl px-3 py-2" type="date" name="date" value="',today(),'">',
              '<select class="border rounded-xl px-3 py-2" name="clientId">',clients.map(c=>'<option value="'+c.id+'">'+c.name+'</option>').join(''),'</select>',
              '<select class="border rounded-xl px-3 py-2" name="reason">',['Presentazione','Follow-up','Listino','Promo','Reclamo','Riscossione','Altro'].map(x=>'<option>'+x+'</option>').join(''),'</select>',
              '<select class="border rounded-xl px-3 py-2" name="esito">',['Positivo','Neutro','Negativo'].map(x=>'<option>'+x+'</option>').join(''),'</select>',
              '<input class="border rounded-xl px-3 py-2" type="date" name="nextDate" placeholder="Prossima">',
              '<div class="md:col-span-3 flex gap-2 items-center">',
                '<input class="border rounded-xl px-3 py-2 flex-1" name="notes" placeholder="Note visita (azioni, feedback)">',
                '<button type="button" id="dictate" class="btn">üé§ Dettatura</button>',
                '</div>',
              '<div class="md:col-span-6 text-right"><button class="btn-primary">Salva</button></div>',
            '</form>',
          '</div></div>',
          '<div class="card"><div class="card-h"><h3 class="font-semibold">Storico visite</h3></div>',
          '<div class="card-b overflow-auto"><table class="min-w-full text-sm"><thead class="bg-slate-100 text-slate-600"><tr>',
          '<th class="text-left px-2 py-2">ID</th><th class="text-left px-2 py-2">Data</th><th class="text-left px-2 py-2">Cliente</th><th class="text-left px-2 py-2">Motivo</th><th class="text-left px-2 py-2">Esito</th><th class="text-left px-2 py-2">Prossima</th><th class="text-left px-2 py-2">Note</th><th class="px-2 py-2"></th>',
          '</tr></thead><tbody id="tbody">',rows(),'</tbody></table></div>',
        '</div>'
      ].join('');

      function repaint(){ document.getElementById('tbody').innerHTML = rows(); document.querySelectorAll('[data-del]').forEach(btn=>btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-del'); if(confirm('Eliminare visita?')){ visits=visits.filter(x=>x.id!==id); setVisits(visits); repaint(); }})); }
      repaint();
      const f=root.querySelector('#fVisit'); f.addEventListener('submit',e=>{e.preventDefault(); const data=Object.fromEntries(new FormData(f).entries()); const id=nextId('V'); const v={id,...data}; visits.unshift(v); setVisits(visits);
        const s=getSettings(); const all=getClients(); const c=all.find(x=>x.id===data.clientId); if(c){ const next=data.nextDate||addDays(data.date,tierToFreq(c.tier||'standard',s)); c.lastVisitDate=data.date; c.nextVisitDate=next; setClients(all); } repaint(); f.reset(); });
      // Dettatura note
      const btnDict = root.querySelector('#dictate');
      if(btnDict){
        btnDict.addEventListener('click', ()=>{
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if(!SpeechRecognition){ alert('Dettatura non supportata su questo browser'); return; }
          const r = new SpeechRecognition();
          r.lang = 'it-IT'; r.interimResults = false; r.maxAlternatives = 1;
          r.onresult = (e)=>{
            const txt = e.results[0][0].transcript || '';
            const notes = root.querySelector('input[name="notes"]');
            notes.value = (notes.value? (notes.value+' ') : '') + txt;
          };
          r.onerror = (e)=> alert('Errore dettatura: '+(e.error||'')); r.start();
        });
      }
    }

    // ‚Äî‚Äî‚Äî Promozioni ‚Äî‚Äî‚Äî
    function renderPromo(root){
      let catalog=getPromos();
      let cPromos=getCPromos();
      const clients=getClients();
      const preClient = window._promoClientPreselect || '';

      function rowCatalog(p){
        return ['<tr class="border-b align-top">',
          '<td class="px-2 py-2"><div class="font-medium">',p.title,'</div><div class="text-xs text-slate-600">',(p.desc||''),'</div></td>',
          '<td class="px-2 py-2">',(p.defaultDays? (p.defaultDays+' gg') : '‚Äî'),'</td>',
          '<td class="px-2 py-2">',(p.provinces||[]).join(', ')||'‚Äî','</td>',
          '<td class="px-2 py-2 text-right"><button class="btn text-red-600 border-red-300 hover:bg-red-50" data-del-cat="',p.id,'">Elimina</button></td>',
        '</tr>'].join('');
      }

      function rowAct(cp){
        const cli = clients.find(c=>c.id===cp.clientId);
        const daysLeft = cp.end ? daysBetween(today(), cp.end) : null;
        const badge = (daysLeft!=null)
          ? (daysLeft<0?'<span class="pill bg-slate-100 text-slate-600 border-slate-200">scaduta</span>'
              : (daysLeft<=7?'<span class="pill bg-amber-100 text-amber-700 border-amber-200">'+daysLeft+'g</span>'
                            : '<span class="pill">'+daysLeft+'g</span>'))
          : '‚Äî';
        return ['<tr class="border-b align-top">',
          '<td class="px-2 py-2">',cli?cli.name:'‚Äî','</td>',
          '<td class="px-2 py-2">',cp.title,'</td>',
          '<td class="px-2 py-2">',fmtDate(cp.start),' ‚Äì ',fmtDate(cp.end),'</td>',
          '<td class="px-2 py-2">',badge,'</td>',
          '<td class="px-2 py-2">',cp.note||'','</td>',
          '<td class="px-2 py-2 text-right">',
            '<button class="btn" data-ics="',cp.id,'">ICS</button> ',
            '<button class="btn text-red-600 border-red-300 hover:bg-red-50" data-del-act="',cp.id,'">Elimina</button>',
          '</td>',
        '</tr>'].join('');
      }

      root.innerHTML=[
        '<div class="space-y-4">',

          '<div class="card"><div class="card-h"><h3 class="font-semibold">Catalogo promozioni</h3></div>',
          '<div class="card-b">',
            '<form id="fCat" class="grid grid-cols-1 md:grid-cols-6 gap-3">',
              '<input class="border rounded-xl px-3 py-2 md:col-span-2" name="title" placeholder="Titolo promo">',
              '<input class="border rounded-xl px-3 py-2" type="number" name="defaultDays" placeholder="Durata standard (giorni)">',
              '<div class="md:col-span-6"><textarea class="border rounded-xl px-3 py-2 w-full" name="desc" placeholder="Descrizione/condizioni"></textarea></div>',
              '<div class="md:col-span-6"><div class="text-sm font-medium mb-2">Province consigliate</div><div class="flex flex-wrap gap-2" id="pProvs">',
                Object.values(TRIVENETO).flat().map(p=>'<label class="px-2 py-1 border rounded-xl text-sm cursor-pointer"><input type="checkbox" value="'+p+'" class="mr-1">'+p+'</label>').join(''),
              '</div></div>',
              '<div class="md:col-span-6 text-right"><button class="btn-primary">Aggiungi a catalogo</button></div>',
            '</form>',
          '</div>',
          '<div class="card"><div class="card-b overflow-auto">',
            '<table class="min-w-full text-sm"><thead class="bg-slate-100 text-slate-600"><tr>',
            '<th class="text-left px-2 py-2">Titolo</th><th class="text-left px-2 py-2">Durata std</th><th class="text-left px-2 py-2">Province</th><th class="px-2 py-2"></th>',
            '</tr></thead><tbody id="rowsCat">', catalog.map(rowCatalog).join('') ,'</tbody></table>',
          '</div></div>',

          '<div class="card"><div class="card-h"><h3 class="font-semibold">Attiva promozione su cliente</h3></div>',
          '<div class="card-b">',
            '<form id="fAct" class="grid grid-cols-1 md:grid-cols-6 gap-3">',
              '<select class="border rounded-xl px-3 py-2 md:col-span-2" name="clientId">',
                clients.map(c=>'<option value="'+c.id+'" '+(preClient===c.id?'selected':'')+'>'+c.name+'</option>').join(''),
              '</select>',
              '<select class="border rounded-xl px-3 py-2 md:col-span-2" name="promoId">',
                catalog.map(p=>'<option value="'+p.id+'">'+p.title+'</option>').join(''),
              '</select>',
              '<input class="border rounded-xl px-3 py-2" type="date" name="start" value="'+today()+'">',
              '<input class="border rounded-xl px-3 py-2" type="date" name="end" placeholder="Fine (opzionale)">',
              '<div class="md:col-span-6"><textarea class="border rounded-xl px-3 py-2 w-full" name="note" placeholder="Note per questo cliente"></textarea></div>',
              '<div class="md:col-span-6 text-right"><button class="btn-primary">Attiva</button></div>',
            '</form>',
          '</div></div>',

          '<div class="card"><div class="card-h"><h3 class="font-semibold">Promozioni per cliente</h3></div>',
            '<div class="card-b overflow-auto">',
              '<table class="min-w-full text-sm"><thead class="bg-slate-100 text-slate-600"><tr>',
              '<th class="text-left px-2 py-2">Cliente</th><th class="text-left px-2 py-2">Promo</th><th class="text-left px-2 py-2">Periodo</th><th class="text-left px-2 py-2">Giorni</th><th class="text-left px-2 py-2">Note</th><th class="px-2 py-2"></th>',
              '</tr></thead><tbody id="rowsAct">', cPromos.map(rowAct).join('') ,'</tbody></table>',
            '</div>',
          '</div>',

        '</div>'
      ].join('');

      const repaintCat=()=>{ document.getElementById('rowsCat').innerHTML = catalog.map(rowCatalog).join(''); attachDelCat(); };
      function attachDelCat(){
        document.querySelectorAll('[data-del-cat]').forEach(b=>b.addEventListener('click',()=>{
          const id=b.getAttribute('data-del-cat');
          if(confirm('Eliminare voce di catalogo?')){
            catalog=catalog.filter(x=>x.id!==id); setPromos(catalog); repaintCat();
          }
        }));
      }
      attachDelCat();

      document.getElementById('fCat').addEventListener('submit',e=>{
        e.preventDefault();
        const data=Object.fromEntries(new FormData(e.target).entries());
        const provinces=[...document.querySelectorAll('#pProvs input[type=checkbox]:checked')].map(x=>x.value);
        const p={id:'PC-'+Date.now(), title:data.title, desc:data.desc, defaultDays:Number(data.defaultDays||0)||null, provinces};
        catalog.unshift(p); setPromos(catalog); e.target.reset(); repaintCat();
      });

      const repaintAct=()=>{ document.getElementById('rowsAct').innerHTML = cPromos.map(rowAct).join(''); attachActBtns(); };
      function attachActBtns(){
        document.querySelectorAll('[data-del-act]').forEach(b=>b.addEventListener('click',()=>{
          const id=b.getAttribute('data-del-act');
          if(confirm('Eliminare attivazione?')){
            cPromos=cPromos.filter(x=>x.id!==id); setCPromos(cPromos); repaintAct();
          }
        }));
        document.querySelectorAll('[data-ics]').forEach(btn=>btn.addEventListener('click',()=>{
          const id=btn.getAttribute('data-ics'); const cp=cPromos.find(x=>x.id===id); if(!cp||!cp.end){ alert('Imposta la data di fine'); return; }
          const end=new Date(cp.end); const start=new Date(end.getTime()-7*24*60*60*1000);
          const pad=n=>String(n).padStart(2,'0');
          const toICS=d=>d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'T'+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());
          const esc=s=>String(s||'').replace(/[\\,;\\n]/g, m => (m==='\\'?'\\\\':m===','?'\\,':m===';'?'\\;':'\\n'));
          const cli=clients.find(c=>c.id===cp.clientId);
          const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CRM Lenti//IT','CALSCALE:GREGORIAN','BEGIN:VEVENT',
            'UID:CP-'+id,'DTSTAMP:'+toICS(new Date()),'DTSTART:'+toICS(start),'DTEND:'+toICS(new Date(start.getTime()+60*60*1000)),
            'SUMMARY:'+esc('Promo in scadenza ‚Äì '+(cli?cli.name:'Cliente')),'DESCRIPTION:'+esc(cp.title+(cp.note?(' ‚Äî '+cp.note):'')),'END:VEVENT','END:VCALENDAR'].join('\r\n');
          const blob=new Blob([ics],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='promo_cliente_'+id+'.ics'; a.click();
        }));
      }
      attachActBtns();

      document.getElementById('fAct').addEventListener('submit',e=>{
        e.preventDefault();
        const data=Object.fromEntries(new FormData(e.target).entries());
        const promo=catalog.find(p=>p.id===data.promoId);
        let end=data.end;
        if(!end && promo?.defaultDays){
          end = addDays(data.start, Number(promo.defaultDays));
        }
        const cp={id:'CP-'+Date.now(), clientId:data.clientId, promoId:data.promoId, title:promo?promo.title:'Promo', start:data.start||today(), end:end||'', note:data.note||''};
        cPromos.unshift(cp); setCPromos(cPromos);
        window._promoClientPreselect='';
        e.target.reset(); repaintAct();
        alert('Promo attivata al cliente');
      });
    }

    // ‚Äî‚Äî‚Äî Fatturati & Statistiche ‚Äî‚Äî‚Äî
    function parseCSV(text){function parseCSV(text){
  const firstLine = (text.split('\n')[0] || '');
  const delim = (firstLine.split(';').length > firstLine.split(',').length)
    ? ';'
    : (firstLine.includes(';') ? ';' : ',');

  const rows = text
    .split(/\r?\n/)
    .filter(r => r.trim().length)
    .map(r => r.split(delim));

  return { header: rows[0].map(h => h.trim()), rows: rows.slice(1) };
}
      const delim = text.indexOf(';')>-1 && text.indexOf(',')>-1 ? (text.split('\n')[0].split(';').length > text.split('\n')[0].split(',').length ? ';' : ',') : (text.indexOf(';')>-1?';':',');
      const rows=text.split(/\r?\n/).filter(r=>r.trim().length).map(r=>r.split(delim));
      return {header:rows[0].map(h=>h.trim()), rows:rows.slice(1)};
    }
    function normalizeAmount(s){ if(s==null) return 0; s=String(s).replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; }

    // ================== FATTURATI (unica tabella: Anno oppure Mese) ==================
function renderFatturati(root){
  // stato UI locale
  window._uiFatt = window._uiFatt || { showImport:false };
  const nowYM = yyyymm();
  const defY  = +nowYM.slice(0,4);
  const defM  = nowYM.slice(5);
  let mode = lsGet('fattMode','month'); // 'month' | 'year'
  let sortState = lsGet('fattSortUnified', { key: mode==='year'?'amountY':'amount', dir:'desc' });

  // dati base
  const clients = getClients();
  const sales   = getSales();   // {clientId, month:'YYYY-MM', amount}
  const salesW  = getSalesW();  // {clientId, year, week, dateISO, amount}

  // util
  const _euro = n => fmtEuro(Number(n)||0);
  const _cmp  = (a,b,dir) => dir==='asc' ? (a>b?1:(a<b?-1:0)) : (a<b?1:(a>b?-1:0));
  const years = [defY-3,defY-2,defY-1,defY];
  const months = [['01','Gennaio'],['02','Febbraio'],['03','Marzo'],['04','Aprile'],['05','Maggio'],['06','Giugno'],['07','Luglio'],['08','Agosto'],['09','Settembre'],['10','Ottobre'],['11','Novembre'],['12','Dicembre']];

  function monthKey(y,m){ return `${y}-${m}`; }
  function monthlyRow(c,y,m){
    const mk = monthKey(y,m);
    const cur = sales.filter(s=>s.clientId===c.id && s.month===mk).reduce((a,b)=>a+Number(b.amount||0),0);
    const prev = (m==='01') ? `${y-1}-12` : `${y}-${String(+m-1).padStart(2,'0')}`;
    const yoy  = `${y-1}-${m}`;
    const prv = sales.filter(s=>s.clientId===c.id && s.month===prev).reduce((a,b)=>a+Number(b.amount||0),0);
    const yv  = sales.filter(s=>s.clientId===c.id && s.month===yoy ).reduce((a,b)=>a+Number(b.amount||0),0);
    return { id:c.id, code:c.code||'', name:c.name, goal:Number(c.goalMonthly||0), amount:cur, delta:cur-prv, deltaY:cur-yv, prev, prevYoY:yoy };
  }
  function yearlyTotals(c,Y){
    let tot=0, prev=0;
    for(let i=1;i<=12;i++){
      const m=`${Y}-${String(i).padStart(2,'0')}`;
      tot  += sales.filter(s=>s.clientId===c.id&&s.month===m).reduce((a,b)=>a+Number(b.amount||0),0);
      const mP=`${Y-1}-${String(i).padStart(2,'0')}`;
      prev += sales.filter(s=>s.clientId===c.id&&s.month===mP).reduce((a,b)=>a+Number(b.amount||0),0);
    }
    const goalY = Number(c.goalMonthly||0)*12;
    return { id:c.id, code:c.code||'', name:c.name, amountY:tot, goalY, deltaYG:tot-goalY, deltaYoY:tot-prev };
  }
  function lastWeek(){
    const set=new Set(salesW.map(w=>w.year+'|'+w.week));
    const arr=[...set].map(s=>({y:+s.split('|')[0], w:+s.split('|')[1]})).sort((a,b)=>a.y-b.y||a.w-b.w);
    return arr.length ? {year:arr[arr.length-1].y, week:arr[arr.length-1].w} : {year:defY, week:1};
  }
  function drawLine(canvasId, labels, series){
    const c=document.getElementById(canvasId); if(!c) return;
    const ctx=c.getContext('2d'), w=c.width=c.clientWidth, h=c.height=200, pad=20;
    ctx.clearRect(0,0,w,h);
    const max=Math.max(1,...series), stepX=(w-2*pad)/Math.max(1,labels.length-1);
    ctx.strokeStyle='#94a3b8'; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
    ctx.strokeStyle='#2563eb'; ctx.beginPath();
    series.forEach((v,i)=>{ const x=pad+i*stepX, y=h-pad-(v/max)*(h-2*pad); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.stroke(); ctx.fillStyle='#0f172a'; ctx.font='10px system-ui';
    labels.forEach((l,i)=>{ const x=pad+i*stepX; ctx.fillText(l.slice(5), x-8, h-6); });
  }

  // UI
  root.innerHTML = [
    '<div class="space-y-4">',

      // ====== CARD PRINCIPALE: selettori + EXPORT/STAMPA in alto a destra
      '<div class="card" id="cardMain">',
        '<div class="card-h">',
          '<div class="flex items-center gap-2 flex-wrap">',
            '<h3 class="font-semibold mr-2">Fatturati</h3>',
            '<label class="text-sm">Periodo ',
              '<select id="periodMode" class="border rounded-xl px-2 py-1 text-sm">',
                '<option value="year">Anno intero</option>',
                '<option value="month">Mese</option>',
              '</select>',
            '</label>',
            '<select id="selYear" class="border rounded-xl px-2 py-1 text-sm">',
              years.map(y=>`<option ${y===defY?'selected':''}>${y}</option>`).join(''),
            '</select>',
            '<select id="selMonth" class="border rounded-xl px-2 py-1 text-sm hidden">',
              months.map(([k,l])=>`<option value="${k}" ${k===defM?'selected':''}>${l}</option>`).join(''),
            '</select>',
          '</div>',
          '<div class="flex-1"></div>',
          '<div class="flex items-center gap-2">',
            '<button id="btnImport" class="btn">Import</button>',
            '<button id="btnExport" class="btn">‚¨áÔ∏è Export CSV</button>',
            '<button id="btnPrint"  class="btn">üñ®Ô∏è Stampa/PDF</button>',
          '</div>',
        '</div>',

        // pannello import (toggle)
        (window._uiFatt.showImport ? [
          '<div class="card-b border-b bg-slate-50/50">',
            '<form id="fImport" class="grid grid-cols-1 md:grid-cols-6 gap-3">',
              '<select id="impType" class="border rounded-xl px-3 py-2">',
                '<option value="monthly">Mensile (cliente, mese YYYY-MM, importo)</option>',
                '<option value="annual">Annuale YTD (cliente, gen..dic)</option>',
              '</select>',
              '<input id="impYear" class="border rounded-xl px-3 py-2" type="number" placeholder="Anno (per annuale)">',
              '<input id="impFile" type="file" accept=".csv,text/csv" class="md:col-span-3">',
              '<div class="text-right md:col-span-1"><button id="doImport" class="btn-primary">Importa</button></div>',
            '</form>',
            '<div class="text-xs text-slate-500 mt-2">Suggerito: colonne <em>client_code</em> o <em>client_name</em>, <em>month</em> (YYYY-MM) e <em>amount</em>, oppure per Annuale 12 colonne da Gen a Dic.</div>',
          '</div>'
        ].join('') : ''),

        // tabella dinamica (anno o mese)
        '<div class="card-b overflow-auto">',
          '<table class="min-w-full text-sm">',
            '<thead class="bg-slate-100 text-slate-600" id="theadMain"></thead>',
            '<tbody id="rowsMain"></tbody>',
          '</table>',
        '</div>',
      '</div>',

      // ====== RIEPILOGO SETTIMANALE (lasciato com‚Äô√®)
      (function(){ const lw=lastWeek(); return [
        '<div class="card"><div class="card-h"><h3 class="font-semibold">Riepilogo settimanale</h3>',
          '<div class="flex items-center gap-2">',
            `<select id="wYear" class="border rounded-xl px-3 py-2">${years.map(y=>`<option ${y===lw.year?'selected':''}>${y}</option>`).join('')}</select>`,
            `<select id="wWeek" class="border rounded-xl px-3 py-2">${Array.from({length:53},(_,i)=>i+1).map(w=>`<option ${w===lw.week?'selected':''}>${w}</option>`).join('')}</select>`,
          '</div>',
        '</div>',
        '<div class="card-b overflow-auto"><table class="min-w-full text-sm">',
          '<thead class="bg-slate-100 text-slate-600"><tr>',
            '<th class="text-left px-2 py-2" data-sortw="name">Cliente</th>',
            '<th class="text-right px-2 py-2" data-sortw="amount">Importo sett.</th>',
            '<th class="text-right px-2 py-2" data-sortw="deltaW">Œî vs sett. prec.</th>',
          '</tr></thead><tbody id="rowsW"></tbody></table></div>'
      ].join(''); })(),

      // ====== GRAFICI (totale + cliente YTD)
      '<div class="card"><div class="card-h"><h3 class="font-semibold">Grafico mensile (totale)</h3></div><div class="card-b"><canvas id="chartTot" style="width:100%"></canvas></div></div>',
      '<div class="card"><div class="card-h"><h3 class="font-semibold">Andamento cliente (YTD)</h3></div>',
        '<div class="card-b">',
          '<div class="flex items-center gap-2 mb-3">',
            `<select id="selClient" class="border rounded-xl px-3 py-2">${clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>`,
            `<select id="yearYTD" class="border rounded-xl px-3 py-2">${years.map(y=>`<option ${y===defY?'selected':''}>${y}</option>`).join('')}</select>`,
          '</div>',
          '<canvas id="chartClient" style="width:100%"></canvas>',
        '</div>',
      '</div>',

    '</div>'
  ].join('');

  // inizializzazione selettori periodo
  const selMode  = document.getElementById('periodMode');  selMode.value = mode;
  const selYear  = document.getElementById('selYear');
  const selMonth = document.getElementById('selMonth'); selMonth.classList.toggle('hidden', mode!=='month');

  // ===== painters: tabella principale
  function paintMain(){
    const Y = +selYear.value;
    const M = selMonth.value;
    const thead = document.getElementById('theadMain');
    const tbody = document.getElementById('rowsMain');

    if(mode==='year'){
      // header
      thead.innerHTML = [
        '<tr>',
          '<th class="text-left px-2 py-2 cursor-pointer" data-sort="name">Cliente</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="goalY">Obiettivo annuo</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="amountY">Fatturato anno</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="deltaYG">Œî vs obiettivo</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="deltaYoY">Œî YoY</th>',
        '</tr>'
      ].join('');

      const rows = clients.map(c=>yearlyTotals(c,Y)).sort((A,B)=>{
        const k=sortState.key, d=sortState.dir;
        if(k==='name')     return _cmp((A.name||'').toLowerCase(), (B.name||'').toLowerCase(), d);
        if(k==='goalY')    return _cmp(A.goalY,B.goalY,d);
        if(k==='amountY')  return _cmp(A.amountY,B.amountY,d);
        if(k==='deltaYG')  return _cmp(A.deltaYG,B.deltaYG,d);
        if(k==='deltaYoY') return _cmp(A.deltaYoY,B.deltaYoY,d);
        return 0;
      }).map(r=>{
        const clsG=r.deltaYG<0?'text-red-600':(r.deltaYG>0?'text-emerald-600':'');
        const clsY=r.deltaYoY<0?'text-red-600':(r.deltaYoY>0?'text-emerald-600':'');
        return [
          '<tr class="border-b">',
            '<td class="px-2 py-2">',r.name,'</td>',
            '<td class="px-2 py-2 text-right">', r.goalY?_euro(r.goalY):'‚Äî','</td>',
            '<td class="px-2 py-2 text-right">', _euro(r.amountY),'</td>',
            '<td class="px-2 py-2 text-right ',clsG,'">', (r.deltaYG>0?'+':''), _euro(r.deltaYG),'</td>',
            '<td class="px-2 py-2 text-right ',clsY,'">', (r.deltaYoY>0?'+':''), _euro(r.deltaYoY),'</td>',
          '</tr>'
        ].join('');
      }).join('');
      tbody.innerHTML = rows;

    } else {
      // mese
      thead.innerHTML = [
        '<tr>',
          '<th class="text-left px-2 py-2 cursor-pointer" data-sort="name">Cliente</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="goal">Obiettivo</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="amount">Fatturato</th>',
          '<th class="text-left  px-2 py-2">Avanzamento</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="delta">Œî MoM</th>',
          '<th class="text-right px-2 py-2 cursor-pointer" data-sort="deltaY">Œî YoY</th>',
        '</tr>'
      ].join('');

      const rows = clients.map(c=>monthlyRow(c,Y,M)).sort((A,B)=>{
        const k=sortState.key, d=sortState.dir;
        if(k==='name')   return _cmp((A.name||'').toLowerCase(), (B.name||'').toLowerCase(), d);
        if(k==='goal')   return _cmp(A.goal,B.goal,d);
        if(k==='amount') return _cmp(A.amount,B.amount,d);
        if(k==='delta')  return _cmp(A.delta,B.delta,d);
        if(k==='deltaY') return _cmp(A.deltaY,B.deltaY,d);
        return 0;
      }).map(r=>{
        const pct = r.goal ? Math.min(100, Math.round(100*r.amount/r.goal)) : null;
        const bar = `<div class="w-40 h-2 bg-slate-200 rounded-full overflow-hidden"><div style="width:${pct||0}%;height:100%" class="bg-blue-500"></div></div> ${pct!=null?(pct+'%'):'‚Äî'}`;
        const cls = r.delta<0?'text-red-600':(r.delta>0?'text-emerald-600':'');
        const clsY= r.deltaY<0?'text-red-600':(r.deltaY>0?'text-emerald-600':'');
        return [
          '<tr class="border-b">',
            '<td class="px-2 py-2">',r.name,'</td>',
            '<td class="px-2 py-2 text-right">', r.goal?_euro(r.goal):'‚Äî','</td>',
            '<td class="px-2 py-2 text-right">', _euro(r.amount),'</td>',
            '<td class="px-2 py-2">', bar ,'</td>',
            '<td class="px-2 py-2 text-right ',cls,'">', (r.delta>0?'+':''), _euro(r.delta),' (',r.prev,')</td>',
            '<td class="px-2 py-2 text-right ',clsY,'">', (r.deltaY>0?'+':''), _euro(r.deltaY),' (',r.prevYoY,')</td>',
          '</tr>'
        ].join('');
      }).join('');
      tbody.innerHTML = rows;
    }

    // sort handlers
    document.querySelectorAll('#theadMain [data-sort]').forEach(th=>th.addEventListener('click', ()=>{
      const key=th.getAttribute('data-sort');
      const dir=(sortState.key===key && sortState.dir==='asc')?'desc':'asc';
      sortState={key,dir}; lsSet('fattSortUnified',sortState); paintMain();
    }));
  }

  // ===== export corrente (in alto a destra)
  function exportCurrentCSV(){
    const Y=+selYear.value, M=selMonth.value;
    if(mode==='year'){
      const rows=[['client_code','client_name','year','amount','annual_goal','delta_vs_goal','delta_yoy']];
      const mapCode=Object.fromEntries(clients.map(c=>[c.id,c.code||'']));
      clients.forEach(c=>{
        const r=yearlyTotals(c,Y);
        rows.push([mapCode[c.id]||'', r.name, String(Y), String(r.amountY||0), String(r.goalY||0), String(r.deltaYG||0), String(r.deltaYoY||0)]);
      });
      const csv=rows.map(r=>r.map(v=>String(v).includes(',')?('"'+String(v).replace(/"/g,'""')+'"'):v).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`fatturato_annuale_${Y}.csv`; a.click();
    } else {
      const rows=[['client_code','client_name','year','month','amount','goal','delta_mom','delta_yoy','prev_month','prev_yoy_month']];
      const mapCode=Object.fromEntries(clients.map(c=>[c.id,c.code||'']));
      clients.forEach(c=>{
        const r=monthlyRow(c,Y,M);
        rows.push([mapCode[c.id]||'', r.name, String(Y), String(M), String(r.amount||0), String(r.goal||0), String(r.delta||0), String(r.deltaY||0), r.prev, r.prevYoY]);
      });
      const csv=rows.map(r=>r.map(v=>String(v).includes(',')?('"'+String(v).replace(/"/g,'""')+'"'):v).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`fatturato_${Y}-${M}.csv`; a.click();
    }
  }

  // ===== stampa/PDF card principale
  function printMain(){
    const node=document.getElementById('cardMain'); const w=window.open('','_blank');
    const Y=+selYear.value, M=selMonth.value;
    const titolo = mode==='year' ? `Riepilogo annuale ${Y}` : `Riepilogo ${Y}-${M}`;
    w.document.write(`<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>${titolo}</title>
      <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;color:#0f172a}
      h1{font-size:18px;margin:0 0 12px}table{width:100%;border-collapse:collapse;font-size:12px}
      th,td{border:1px solid #e2e8f0;padding:6px 8px;text-align:right}th{text-align:left;background:#f1f5f9;color:#475569}
      td:first-child,th:first-child{text-align:left}</style></head><body>
      <h1>${titolo}</h1>${node.querySelector('table')?.outerHTML || node.innerHTML}</body></html>`);
    w.document.close(); w.focus(); w.print();
  }

  // ===== Import (pannello dietro pulsante)
  function toggleImport(){ window._uiFatt.showImport=!window._uiFatt.showImport; renderFatturati(document.getElementById('view')); }

  function doImportHandler(e){
    e.preventDefault();
    const type = document.getElementById('impType').value;
    const year = +document.getElementById('impYear').value || defY;
    const file = document.getElementById('impFile').files?.[0];
    if(!file){ alert('Seleziona un CSV'); return; }
    file.text().then(text=>{
      const {header, rows} = parseCSV(text);
      const H = header.map(h=>h.toLowerCase().trim());
      const idx = (names)=>{ for(const n of names){ const i=H.indexOf(n.toLowerCase()); if(i>-1) return i; } return -1; };
      const iCode = idx(['client_code','codice','codice cliente','code']);
      const iName = idx(['client_name','cliente','ragione sociale','nome']);
      if(type==='monthly'){
        const iMonth = idx(['month','mese']);
        const iAmt   = idx(['amount','importo','fatturato','valore']);
        if(iMonth<0 || iAmt<0 || (iCode<0 && iName<0)){ alert('CSV non valido (servono: cliente + month + amount)'); return; }
        let list = getSales(); let add=0, upd=0, skip=0;
        rows.forEach(r=>{
          const code = iCode>-1 ? (r[iCode]||'').trim() : '';
          const name = iName>-1 ? (r[iName]||'').trim() : '';
          const month = (r[iMonth]||'').trim();
          const amount = normalizeAmount(r[iAmt]||'0');
          if(!month){ skip++; return; }
          const cli = clients.find(c=> (code && c.code===code) || (!code && name && (c.name||'').toLowerCase()===name.toLowerCase()));
          if(!cli){ skip++; return; }
          // rimuovi eventuale entry esistente per quel clientId+month
          list = list.filter(x=> !(x.clientId===cli.id && x.month===month) );
          list.push({clientId:cli.id, month, amount});
          add++;
        });
        setSales(list);
        alert(`Import mensile: ${add} righe importate, ${skip} scartate`);
      } else {
        // annuale YTD: colonne gen..dic
        const findCol = (labels)=> labels.findIndex(l=>H.includes(l));
        const iJan=findCol(['gen','gennaio','01']); const iFeb=findCol(['feb','febbraio','02']); const iMar=findCol(['mar','marzo','03']);
        const iApr=findCol(['apr','aprile','04']);  const iMay=findCol(['mag','maggio','05']); const iJun=findCol(['giu','giugno','06']);
        const iJul=findCol(['lug','luglio','07']);  const iAug=findCol(['ago','agosto','08']); const iSep=findCol(['set','settembre','09']);
        const iOct=findCol(['ott','ottobre','10']); const iNov=findCol(['nov','novembre','11']); const iDec=findCol(['dic','dicembre','12']);
        const idxs=[iJan,iFeb,iMar,iApr,iMay,iJun,iJul,iAug,iSep,iOct,iNov,iDec];
        if((iCode<0 && iName<0) || idxs.every(i=>i<0)){ alert('CSV annuale non riconosciuto (serve cliente + colonne mesi)'); return; }
        let list = getSales(); let add=0, skip=0;
        rows.forEach(r=>{
          const code = iCode>-1 ? (r[iCode]||'').trim() : '';
          const name = iName>-1 ? (r[iName]||'').trim() : '';
          const cli = clients.find(c=> (code && c.code===code) || (!code && name && (c.name||'').toLowerCase()===name.toLowerCase()));
          if(!cli){ skip++; return; }
          idxs.forEach((ix,mm)=>{
            if(ix<0) return;
            const amount = normalizeAmount(r[ix]||'0');
            const month = `${year}-${String(mm+1).padStart(2,'0')}`;
            // replace
            list = list.filter(x=> !(x.clientId===cli.id && x.month===month) );
            list.push({clientId:cli.id, month, amount});
            add++;
          });
        });
        setSales(list);
        alert(`Import annuale: ${add} mesi importati, ${skip} righe cliente non trovate`);
      }
      renderFatturati(document.getElementById('view'));
    });
  }

  // ===== settimanale + grafici (invariati)
  let sortW = lsGet('fattSortW',{key:'amount',dir:'desc'});
  function paintWeekly(){
    const y=+document.getElementById('wYear').value, w=+document.getElementById('wWeek').value;
    const prevY=(w===1)?(y-1):y, prevW=(w===1)?52:(w-1);
    const rows = clients.map(c=>{
      const a=(salesW.find(x=>x.clientId===c.id&&x.year===y&&x.week===w)||{}).amount||0;
      const p=(salesW.find(x=>x.clientId===c.id&&x.year===prevY&&x.week===prevW)||{}).amount||0;
      return {name:c.name, amount:Number(a||0), deltaW:Number(a||0)-Number(p||0)};
    }).sort((A,B)=>{ const k=sortW.key,d=sortW.dir; if(k==='name')return _cmp(A.name.toLowerCase(),B.name.toLowerCase(),d); if(k==='amount')return _cmp(A.amount,B.amount,d); if(k==='deltaW')return _cmp(A.deltaW,B.deltaW,d); return 0; })
      .map(r=>{
        const cls=r.deltaW<0?'text-red-600':(r.deltaW>0?'text-emerald-600':'');
        return ['<tr class="border-b">','<td class="px-2 py-2">',r.name,'</td>','<td class="px-2 py-2 text-right">',_euro(r.amount),'</td>','<td class="px-2 py-2 text-right ',cls,'">',(r.deltaW>0?'+':''),_euro(r.deltaW),'</td>','</tr>'].join('');
      }).join('');
    document.getElementById('rowsW').innerHTML = rows;
    document.querySelectorAll('[data-sortw]').forEach(th=>th.onclick=()=>{ const key=th.getAttribute('data-sortw'); const dir=(sortW.key===key&&sortW.dir==='asc')?'desc':'asc'; sortW={key,dir}; lsSet('fattSortW',sortW); paintWeekly(); });
  }
  function paintCharts(){
    const monthsKeys=[]; const now=new Date();
    for(let i=11;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); monthsKeys.push(d.toISOString().slice(0,7)); }
    const totals=monthsKeys.map(m=> sales.filter(s=>s.month===m).reduce((a,b)=>a+Number(b.amount||0),0));
    drawLine('chartTot', monthsKeys, totals);
    const id=document.getElementById('selClient').value, Y=+document.getElementById('yearYTD').value;
    const labs=[...Array(12)].map((_,i)=>`${Y}-${String(i+1).padStart(2,'0')}`);
    const ser=labs.map(m=> sales.filter(s=>s.clientId===id && s.month===m).reduce((a,b)=>a+Number(b.amount||0),0));
    drawLine('chartClient', labs, ser);
  }

  // ===== listeners top
  document.getElementById('btnImport').addEventListener('click', toggleImport);
  const fImp = document.getElementById('fImport');
  if(fImp) fImp.addEventListener('submit', doImportHandler);

  document.getElementById('btnExport').addEventListener('click', exportCurrentCSV);
  document.getElementById('btnPrint').addEventListener('click', printMain);

  selMode.addEventListener('change', ()=>{
    mode = selMode.value;
    lsSet('fattMode', mode);
    // default sort per modalit√†
    sortState = (mode==='year')
      ? { key:'amountY', dir:'desc' }
      : { key:'amount',  dir:'desc' };
    lsSet('fattSortUnified', sortState);
    selMonth.classList.toggle('hidden', mode!=='month');
    paintMain();
  });
  selYear.addEventListener('change', paintMain);
  selMonth.addEventListener('change', paintMain);

  // init
  paintMain();
  paintWeekly();
  paintCharts();

  // altri listeners
  document.getElementById('wYear').addEventListener('change', paintWeekly);
  document.getElementById('wWeek').addEventListener('change', paintWeekly);
  document.getElementById('selClient').addEventListener('change', paintCharts);
  document.getElementById('yearYTD').addEventListener('change', paintCharts);
}


    // ‚Äî‚Äî‚Äî Agenda (con editTour annidata) ‚Äî‚Äî‚Äî
function renderAgenda(root){
  let tours = getTours();

  function dueCandidates(prov){
    const s = getSettings(), now = today();
    return getClients().filter(c =>
      (!prov || c.prov === prov) &&
      (!c.lastVisitDate ||
        new Date(addDays(c.lastVisitDate, tierToFreq(c.tier||'standard', s))) <=
        new Date(addDays(now, 7))
      )
    );
  }

  // URL Google Maps (nessuna variabile 's' fantasma)
  function gmapsUrl(origin, stops){
    const enc  = v => encodeURIComponent(v||'');
    const s    = getSettings();
    const orig = origin || s.baseCity || 'Padova';
    const arr  = (stops||[]).map(st => getClients().find(c=>c.id===st.clientId) || {});
    if(!arr.length) return '#';
    const dest = enc((arr[arr.length-1].address || arr[arr.length-1].city || '').trim());
    const way  = arr.slice(0, Math.max(0, arr.length-1))
                    .map(x => enc((x.address||x.city||'').trim()))
                    .join('|');
    let url = 'https://www.google.com/maps/dir/?api=1&travelmode=driving&origin='+enc(orig)+'&destination='+dest;
    if(way) url += '&waypoints='+way;
    return url;
  }

  function paint(){
    const provOpts = Object.values(TRIVENETO).flat().map(p=>`<option value="${p}">${p}</option>`).join('');

    root.innerHTML = `
      <div class="space-y-4">
        <div class="card">
          <div class="card-h"><h3 class="font-semibold">Nuovo giro</h3></div>
          <div class="card-b">
            <form id="fTour" class="grid grid-cols-1 md:grid-cols-6 gap-3">
              <input class="border rounded-xl px-3 py-2" type="date" name="date" value="${today()}">
              <input class="border rounded-xl px-3 py-2 md:col-span-2" name="name" placeholder="Nome giro (es. Padova nord)">
              <select class="border rounded-xl px-3 py-2" name="prov">
                <option value="">Tutte le province</option>
                ${provOpts}
              </select>
              <input class="border rounded-xl px-3 py-2" type="number" name="perDay" value="4" placeholder="Stop per giorno">
              <input class="border rounded-xl px-3 py-2 md:col-span-2" name="origin" placeholder="Partenza da (es. Prato della Valle, Padova)">
              <input class="border rounded-xl px-3 py-2" type="time" name="startTime" value="08:30">
              <div class="md:col-span-6 text-right"><button class="btn-primary">Crea</button></div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-h"><h3 class="font-semibold">Giri pianificati</h3></div>
          <div class="card-b" id="toursList"></div>
        </div>
      </div>
    `;

    // Lista giri
    const list = root.querySelector('#toursList');
    list.innerHTML = tours.length ? tours.map(t => {
      const stopsTxt = (t.stops||[])
        .map((st,i)=> (i+1)+'. '+((getClients().find(c=>c.id===st.clientId)||{}).name||st.clientId))
        .join('<br>');
      const url = gmapsUrl(t.origin, t.stops);
      return `
        <div class="border rounded-xl p-3 mb-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">${t.name || ('Giro '+t.date)}</div>
              <div class="text-xs text-slate-500">${fmtDate(t.date)}</div>
            </div>
            <div class="space-x-2">
              <a class="btn" target="_blank" href="${url}">Apri in Google Maps</a>
              <button class="btn" data-edit="${t.id}">Modifica</button>
              <button class="btn text-red-600 border-red-300 hover:bg-red-50" data-del="${t.id}">Elimina</button>
            </div>
          </div>
          <div class="mt-2 text-sm">${stopsTxt || '‚Äî'}</div>
        </div>`;
    }).join('') : '<div class="text-sm text-slate-600">Nessun giro salvato</div>';

    // Azioni lista
    list.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-del');
      if(confirm('Eliminare giro?')){ tours=tours.filter(x=>x.id!==id); setTours(tours); paint(); }
    }));
    list.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-edit'); editTour(id);
    }));

    // Nuovo giro
    root.querySelector('#fTour').addEventListener('submit', e=>{
      e.preventDefault();
      const data=Object.fromEntries(new FormData(e.target).entries());
      const prov = data.prov || '';
      const perDay = Math.max(1, Number(data.perDay||4));
      const candidates = dueCandidates(prov);
      const firstGroup = candidates.slice(0, perDay);

      const t = {
        id: nextId('T'),
        date: data.date,
        name: data.name || ('Giro '+data.date),
        prov,
        origin: (data.origin || getSettings().baseCity || 'Padova'),
        startTime: (data.startTime || '08:30'),
        stops: firstGroup.map(c=>({clientId:c.id}))
      };
      tours = getTours(); tours.unshift(t); setTours(tours);
      paint();
      alert('Giro creato con '+firstGroup.length+' tappe. Partenza '+t.origin+' ore '+t.startTime);
    });
  }

  // ====== EDIT TOUR (annidata) ======
  function editTour(id){
    const t = getTours().find(x=>x.id===id);
    if(!t){ paint(); return; }

    const candidates = getClients().filter(c=>!t.prov || c.prov===t.prov);
    const container = document.getElementById('view');

    container.innerHTML = [
      '<div class="space-y-4">',
        `<div class="card"><div class="card-h"><h3 class="font-semibold">Modifica giro ‚Äî ${t.name}</h3></div>`,
        '<div class="card-b grid grid-cols-1 md:grid-cols-2 gap-4">',
          '<div>',
            `<div class="font-medium mb-2">Clienti candidati ${t.prov?('('+t.prov+')'):''}</div>`,
            `<div class="border rounded-xl p-2 h-80 overflow-auto" id="cand">`,
              candidates.map(c=>`<div class="flex items-center justify-between border-b py-1"><div>${c.name} (${c.prov||''})</div><button class="btn" data-add="${c.id}">Aggiungi</button></div>`).join(''),
            '</div>',
          '</div>',
          '<div>',
            '<div class="font-medium mb-2">Stop del giro (riordina)</div>',
            '<div class="border rounded-xl p-2 h-80 overflow-auto" id="stops"></div>',
          '</div>',
        '</div>',
        '<div class="card-b text-right">',
          '<button class="btn" id="ok">Salva</button> ',
          '<a class="btn" id="gmap" target="_blank">Apri in Google Maps</a> ',
          '<button class="btn-primary" id="finish">Segna visite effettuate</button>',
        '</div>',
      '</div>'
    ].join('');

    const stopsBox = document.getElementById('stops');

    function repaintStops(){
      stopsBox.innerHTML = (t.stops||[]).map((s,i)=>{
        const name=(getClients().find(c=>c.id===s.clientId)||{}).name||s.clientId;
        return `<div class="flex items-center justify-between border-b py-1">
          <div>${i+1}. ${name}</div>
          <div class="space-x-1">
            <button class="btn" data-up="${i}">‚Üë</button>
            <button class="btn" data-down="${i}">‚Üì</button>
            <button class="btn text-red-600 border-red-300 hover:bg-red-50" data-rm="${i}">‚úï</button>
          </div>
        </div>`;
      }).join('');

      const g = document.getElementById('gmap');
      g.href = gmapsUrl(t.origin, t.stops);

      stopsBox.querySelectorAll('[data-rm]').forEach(b=>b.addEventListener('click',()=>{
        const i=Number(b.getAttribute('data-rm'));
        t.stops.splice(i,1);
        setTours([...getTours().filter(x=>x.id!==id), t]);
        repaintStops();
      }));
      stopsBox.querySelectorAll('[data-up]').forEach(b=>b.addEventListener('click',()=>{
        const i=Number(b.getAttribute('data-up'));
        if(i>0){ const tmp=t.stops[i-1]; t.stops[i-1]=t.stops[i]; t.stops[i]=tmp;
          setTours([...getTours().filter(x=>x.id!==id), t]); repaintStops(); }
      }));
      stopsBox.querySelectorAll('[data-down]').forEach(b=>b.addEventListener('click',()=>{
        const i=Number(b.getAttribute('data-down'));
        if(i<t.stops.length-1){ const tmp=t.stops[i+1]; t.stops[i+1]=t.stops[i]; t.stops[i]=tmp;
          setTours([...getTours().filter(x=>x.id!==id), t]); repaintStops(); }
      }));
    }
    repaintStops();

    document.getElementById('cand').querySelectorAll('[data-add]').forEach(b=>b.addEventListener('click',()=>{
      const cid=b.getAttribute('data-add');
      t.stops.push({clientId:cid});
      setTours([...getTours().filter(x=>x.id!==id), t]);
      repaintStops();
    }));

    document.getElementById('ok').addEventListener('click',()=>{
      alert('Giro salvato'); renderAgenda(document.getElementById('view'));
    });

    document.getElementById('finish').addEventListener('click',()=>{
      const visits = getVisits();
      const s = getSettings();
      (t.stops||[]).forEach(st=>{
        const v={id:nextId('V'), date:t.date, clientId:st.clientId, reason:'Giro: '+t.name, esito:'Positivo', notes:''};
        visits.push(v);
        const all=getClients(); const c=all.find(x=>x.id===st.clientId);
        if(c){ const next=addDays(t.date, tierToFreq(c.tier||'standard', s)); c.lastVisitDate=t.date; c.nextVisitDate=next; setClients(all); }
      });
      setVisits(visits);
      alert('Visite segnate e prossime date aggiornate');
      renderAgenda(document.getElementById('view'));
    });
  }

  // Prima pittura
  paint();
}

    // ‚Äî‚Äî‚Äî Impostazioni + Firebase ‚Äî‚Äî‚Äî
    function renderImpostazioni(root){
      let s=getSettings(); const fb=getFB();
      root.innerHTML=[
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">',
          '<div class="card"><div class="card-h"><h3 class="font-semibold">Dati agenzia</h3></div>',
            '<div class="card-b grid grid-cols-1 gap-3">',
              '<input class="border rounded-xl px-3 py-2" id="agencyName" value="',(s.agencyName||''),'" placeholder="Nome Agenzia">',
              '<input class="border rounded-xl px-3 py-2" id="agentName" value="',(s.agentName||''),'" placeholder="Nome Agente">',
              '<input class="border rounded-xl px-3 py-2" id="baseCity" value="',(s.baseCity||''),'" placeholder="Citt√† di partenza (base)">',
              '<input class="border rounded-xl px-3 py-2" id="annualGoal" type="number" value="',(s.annualGoal||0),'" placeholder="Obiettivo annuo">',
              '<div class="text-right"><button id="saveA" class="btn-primary">Salva</button></div>',
            '</div></div>',
          '<div class="card"><div class="card-h"><h3 class="font-semibold">Frequenza visite (giorni)</h3></div>',
            '<div class="card-b grid grid-cols-1 md:grid-cols-3 gap-3">',
              '<label class="text-sm">Standard<input class="border rounded-xl px-3 py-2" type="number" id="freqStandard" value="',(s.freqStandard||90),'" ></label>',
              '<label class="text-sm">Importante<input class="border rounded-xl px-3 py-2" type="number" id="freqImportant" value="',(s.freqImportant||30),'" ></label>',
              '<label class="text-sm">Nuovo<input class="border rounded-xl px-3 py-2" type="number" id="freqNew" value="',(s.freqNew||21),'" ></label>',
            '</div>',
            '<div class="card-b pt-0 text-right"><button id="saveF" class="btn-primary">Salva frequenze</button></div>',
          '</div>',
          '<div class="card md:col-span-2"><div class="card-h"><h3 class="font-semibold">Sincronizzazione (Firebase)</h3></div>',
            '<div class="card-b grid grid-cols-1 gap-3">',
              '<label class="text-sm">Agent ID (univoco)<input class="border rounded-xl px-3 py-2" id="fbAgent" value="',(fb.agentId||''),'" placeholder="es. riccardo-masetto-2025-privato"></label>',
              '<textarea id="fbConfig" class="border rounded-xl px-3 py-2 w-full" placeholder="Incolla qui il JSON di config Firebase">',(fb.config?JSON.stringify(fb.config):''),'</textarea>',
              '<div class="flex gap-2 items-center flex-wrap"><label class="flex items-center gap-2"><input type="checkbox" id="fbEnable" ',(fb.enabled?'checked':''),' > Abilita</label><button id="fbConnect" class="btn">Connetti</button><button id="fbTest" class="btn">Test connessione</button><button id="fbUp" class="btn">Upload dati</button><button id="fbDown" class="btn">Scarica dati</button></div>',
              '<div class="space-y-2">',
                '<div class="text-sm font-medium">Autenticazione</div>',
                '<label class="flex items-center gap-2">',
                '<input type="radio" name="fbAuthMode" value="anon" ',((fb.authMode||'anon')==='anon'?'checked':''),' > Accesso anonimo (consigliato)',
                '</label>',
                '<label class="flex items-center gap-2">',
                  '<input type="radio" name="fbAuthMode" value="password" ',((fb.authMode||'anon')==='password'?'checked':''),' > Email + Password',
                '</label>',
                '<div class="grid grid-cols-1 md:grid-cols-2 gap-2">',
                  '<input id="fbEmail" class="border rounded-xl px-3 py-2" value="',(fb.email||''),'" placeholder="Email (se usi password)">',
                  '<input id="fbPass" type="password" class="border rounded-xl px-3 py-2" placeholder="Password (non viene salvata)">',
                '</div>',
              '</div>',              
              '<div id="fbStatus" class="text-xs text-slate-500">Stato: non connesso</div>',
            '</div>',
          '</div>',
          '<div class="card md:col-span-2"><div class="card-h"><h3 class="font-semibold">Backup & Import</h3></div>',
            '<div class="card-b flex flex-col gap-2">',
              '<button id="export" class="btn-primary">Scarica backup JSON</button>',
              '<label class="block"><span class="text-sm text-slate-600">Importa backup JSON</span><input type="file" accept="application/json" id="import" class="block mt-1"></label>',
              '<button id="wipe" class="btn border-red-300 text-red-600 hover:bg-red-50">Svuota tutti i dati</button>',
            '</div>',
          '</div>',
        '</div>'
      ].join('');

      function val(sel){ return root.querySelector(sel).value; }
      document.getElementById('saveA').addEventListener('click',()=>{ s={...s,agencyName:val('#agencyName'),agentName:val('#agentName'),baseCity:val('#baseCity'),annualGoal:Number(val('#annualGoal')||0)}; setSettings(s); alert('Salvato'); });
      document.getElementById('saveF').addEventListener('click',()=>{ s={...s,freqStandard:Number(val('#freqStandard')||0),freqImportant:Number(val('#freqImportant')||0),freqNew:Number(val('#freqNew')||0)}; setSettings(s); alert('Frequenze aggiornate'); });

      document.getElementById('export').addEventListener('click',()=>{ const payload={settings:getSettings(),clients:getClients(),visits:getVisits(),promos:getPromos(),sales:getSales(),salesW:getSalesW(),tours:getTours(),firebase:getFB()}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crm-agente-backup.json'; a.click(); });
      document.getElementById('import').addEventListener('change',ev=>{ const file=ev.target.files?.[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{ try{ const data=JSON.parse(fr.result); ['settings','clients','visits','promos','sales','salesW','tours','firebase'].forEach(k=>{ if(data[k]!=null) lsSet(k,data[k]); }); alert('Import eseguito. Ricarica la pagina.'); }catch{ alert('File non valido'); } }; fr.readAsText(file); });
      document.getElementById('wipe').addEventListener('click',()=>{ if(confirm('Sicuro?')){ ['settings','clients','visits','promos','sales','salesW','tours','firebase','counters'].forEach(k=>localStorage.removeItem(k)); location.reload(); } });

      function saveFB(){
        const enabled=document.getElementById('fbEnable').checked;
        const agentId=val('#fbAgent');
        let conf=null;
        try{ conf=JSON.parse(val('#fbConfig')||'null'); }catch{ alert('Config non √® un JSON valido'); return; }
        const authMode = (root.querySelector('input[name="fbAuthMode"]:checked')?.value)||'anon';
        const email = (document.getElementById('fbEmail')?.value)||'';
        setFB({enabled, agentId, config:conf, authMode, email});
        document.getElementById('fbStatus').textContent='Stato: impostazioni salvate';
      }

      async function fbConnect(){
        try{
          document.getElementById('fbStatus').textContent='Stato: connessione in corso...';
          const ok = await ensureFirebaseConnected();
          if(!ok){ alert('Compila agent id, config e abilita'); document.getElementById('fbStatus').textContent='Stato: manca configurazione'; return; }
          const uid = window._fbAuth.currentUser?.uid || '(anonimo)';
          document.getElementById('fbStatus').textContent='Stato: connesso (UID '+uid+')';
          alert('Connesso (Anonymous)');
        }catch(e){
          console.error(e);
          alert('Errore connessione: '+(e?.message||e));
          document.getElementById('fbStatus').textContent='Stato: errore connessione';
        }
      }

      async function fbTest(){
        try{
          const ok = await ensureFirebaseConnected();
          if(!ok){ alert('Connettiti prima'); return; }
          const fb=getFB();
          document.getElementById('fbStatus').textContent='Stato: test in corso...';
          const ref=window._fbDB.collection('agents').doc(fb.agentId).collection('ping').doc('test');
          await ref.set({at:new Date().toISOString(), ua:navigator.userAgent});
          const snap=await ref.get();
          if(snap.exists){
            alert('Test OK: lettura/scrittura Firestore riuscita.');
            document.getElementById('fbStatus').textContent='Stato: test OK';
          } else {
            alert('Test fallito: documento non trovato.');
            document.getElementById('fbStatus').textContent='Stato: test fallito';
          }
        }catch(e){
          console.error(e);
          alert('Test errore: '+(e?.message||e));
          document.getElementById('fbStatus').textContent='Stato: errore test';
        }
      }

      async function fbUpload(){
        try{
          const ok = await ensureFirebaseConnected();
          if(!ok){ alert('Connettiti prima'); return; }
          document.getElementById('fbStatus').textContent='Stato: upload in corso...';
          const fb=getFB();
          const docRef=window._fbDB.collection('agents').doc(fb.agentId).collection('data').doc('v1');
          const payload={settings:getSettings(),clients:getClients(),visits:getVisits(),promos:getPromos(),sales:getSales(),salesW:getSalesW(),tours:DEFAULT_SETTINGS(),cPromos:getCPromos(),ts:new Date().toISOString()};
          await docRef.set(payload);
          setSync({lastSyncISO:new Date().toISOString()});
          document.getElementById('fbStatus').textContent='Stato: upload completato';
          alert('Upload completato');
        }catch(e){
          console.error(e);
          alert('Errore upload: '+(e?.message||e));
          document.getElementById('fbStatus').textContent='Stato: errore upload';
        }
      }

      async function fbDownload(){
        try{
          const ok = await ensureFirebaseConnected();
          if(!ok){ alert('Connettiti prima'); return; }
          document.getElementById('fbStatus').textContent='Stato: download in corso...';
          const fb=getFB();
          const docRef=window._fbDB.collection('agents').doc(fb.agentId).collection('data').doc('v1');
          const snap=await docRef.get();
          if(!snap.exists){
            document.getElementById('fbStatus').textContent='Stato: nessun dato sul cloud';
            alert('Nessun dato sul cloud');
            return;
          }
          const data=snap.data();
          ['settings','clients','visits','promos','sales','salesW','tours','cPromos'].forEach(k=>{ if(data[k]!=null) lsSet(k,data[k]); });
          if(data.ts){ setSync({lastSyncISO:data.ts}); }
          document.getElementById('fbStatus').textContent='Stato: dati scaricati ('+ new Date().toLocaleString('it-IT') +')';
          alert('Scaricato. Ricarico l‚Äôapp per applicare i dati.');
          location.reload();
        }catch(e){
          console.error(e);
          alert('Errore download: '+(e?.message||e));
          document.getElementById('fbStatus').textContent='Stato: errore download';
        }
      }

      document.getElementById('fbEnable').addEventListener('change',saveFB);
      document.getElementById('fbAgent').addEventListener('change',saveFB);
      document.getElementById('fbConfig').addEventListener('change',saveFB);
      document.getElementById('fbConnect').addEventListener('click',fbConnect);
      document.getElementById('fbTest').addEventListener('click',fbTest);
      document.getElementById('fbUp').addEventListener('click',fbUpload);
      document.getElementById('fbDown').addEventListener('click',fbDownload);
    }

    // ‚Äî‚Äî‚Äî Quick visit ‚Äî‚Äî‚Äî
    function registerQuickVisit(clientId){
      const s=getSettings();const clients=getClients();const visits=getVisits();
      const id=nextId('V'); const v={id,date:today(),clientId,reason:'Visita rapida',esito:'Positivo',notes:''};
      visits.unshift(v); setVisits(visits);
      const c=clients.find(x=>x.id===clientId);
      if(c){ const next=addDays(today(),tierToFreq(c.tier||'standard',s)); c.lastVisitDate=today(); c.nextVisitDate=next; setClients([...clients]); }
      alert('Visita registrata. Prossima consigliata aggiornata.');
    }

    // ‚Äî‚Äî‚Äî Bootstrap ‚Äî‚Äî‚Äî
    window.addEventListener('error', e=>{
  console.error('GlobalError:', e.error || e.message);
  alert('Errore: '+(e.message||'')+'\nControlla la console (F12) per i dettagli.');
});
window.addEventListener('unhandledrejection', e=>{
  console.error('UnhandledRejection:', e.reason);
  alert('Errore asincrono: '+(e.reason?.message||e.reason||''));
});

    render();
  </script>
</body>
</html>
